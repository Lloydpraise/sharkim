<!DOCTYPE html>
<html lang="en">

<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17577238441"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'AW-17577238441');
  </script>
  
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="icon" type="image/png" href="images/icon%20logo.png">
  <title>Product Details - Sharkim Traders</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  
  <style>
    html, body { max-width: 100%; overflow-x: hidden; font-family: "Times New Roman", Times, serif, Arial, Helvetica, sans-serif; }
    body { padding-bottom: 80px; /* Space for mobile sticky footer */ }
    img, svg { max-width: 100%; height: auto; }
    
    /* Brand Colors */
    .brand-orange { color: #ea580c; }
    .bg-brand-orange { background-color: #ea580c; }
    .text-brand-orange { color: #ea580c; }
    .brand-green { color: #25D366; } 
    .bg-brand-green { background-color: #25D366; }

    /* Announcement Bar Gradient */
    .announcement-bar {
        background: linear-gradient(90deg, #ac8334, #f59e0b, #ac8334);
        background-size: 200% 200%;
        animation: gradientMove 10s ease infinite;
    }
    
    /* Header Background */
    .header-bg { background-color: #f3f4f6; }
    
    /* AI Search Button Glow (copied from indexlast exact style) */
    .ai-search-glow {
      position: relative;
      z-index: 0;
      overflow: hidden;
      border-radius: 9999px; /* Rounded full */
    }
    .ai-search-glow::before {
      content: '';
      position: absolute;
      z-index: -2;
      left: -50%; top: -50%; width: 200%; height: 200%;
      background-color: #399953;
      background-repeat: no-repeat;
      background-size: 50% 50%, 50% 50%;
      background-position: 0 0, 100% 0, 100% 100%, 0 100%;
      background-image: linear-gradient(#399953, #399953), linear-gradient(#fbb300, #fbb300), linear-gradient(#d53e33, #d53e33), linear-gradient(#377af5, #377af5);
      animation: rotate 4s linear infinite;
    }
    .ai-search-glow::after {
      content: '';
      position: absolute;
      z-index: -1;
      left: 3px; top: 3px; width: calc(100% - 6px); height: calc(100% - 6px);
      background: white;
      border-radius: 9999px;
    }

    /* Horizontal Scrollers */
    .horizontal-scroll {
      display: flex; overflow-x: auto; gap: 1rem; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; padding-bottom: 1rem;
    }
    .horizontal-scroll > * { scroll-snap-align: start; flex: 0 0 48%; }
    @media (min-width: 768px) {
      .horizontal-scroll > * { flex: 0 0 20%; }
    }

    /* Animations */
    @keyframes rotate { 100% { transform: rotate(1turn); } }
    @keyframes gradientMove { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

    /* Discount Badge */
    #discount-badge, .discount-badge { background: #ea580c !important; color: #ffffff !important; padding: 2px 6px !important; border-radius: 4px !important; }

    /* Magnifier Lens */
    .zoom-container { position: relative; overflow: hidden; display: block; border-radius: 12px; border: 1px solid #e5e7eb; }
    .zoom-lens {
        position: absolute; border: 2px solid #ea580c; border-radius: 50%;
        width: 150px; height: 150px; pointer-events: none; opacity: 0; transition: opacity 0.2s;
        background-repeat: no-repeat; box-shadow: 0 0 10px rgba(0,0,0,0.2); z-index: 50;
    }

    /* Sticky Footer for Mobile */
    .sticky-mobile-footer {
        position: fixed; bottom: 0; left: 0; right: 0; background: white;
        padding: 12px; box-shadow: 0 -4px 6px -1px rgba(0,0,0,0.1); z-index: 50;
        display: flex; gap: 10px;
    }
    @media(min-width: 768px) {
        .sticky-mobile-footer { display: none; }
        body { padding-bottom: 0; }
    }

    /* Breadcrumb: keep on a single line (no wrapping) and truncate if necessary */
    nav .breadcrumb { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: flex; flex-wrap: nowrap; gap: 0.5rem; align-items: center; }
    nav .breadcrumb li { flex: 0 0 auto; }
    nav .breadcrumb li a { white-space: nowrap; display: inline-block; }
    @media (max-width: 420px) {
      nav .breadcrumb { gap: 0.35rem; font-size: 0.95rem; }
    }
  </style>

    <script type="application/ld+json" id="product-jsonld"></script>
</head>

<body class="bg-gray-50">

<div class="announcement-bar w-full text-white text-xs md:text-sm text-center py-2 px-4 font-bold tracking-wide">
  ðŸŽ‰ FREE Shipping on orders over Ksh 5000! | Limited Time Deals! ðŸšš
</div>

<header class="header-bg py-3 sticky top-0 z-40 shadow-sm">
  <div class="max-w-7xl mx-auto px-3 relative">
    <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <a href="index.html" class="flex-shrink-0 absolute left-1/2 transform -translate-x-1/2 md:static md:transform-none z-10">
               <img src="images/sharkim_gold_logo.png" alt="Sharkim Logo" class="h-16 md:h-24 object-contain">
          </a>
        </div>

        <div class="hidden md:flex flex-1 justify-center mx-12">
            <div class="relative w-full max-w-2xl flex items-center gap-4">
                <div class="relative flex-1">
                    <input type="text" id="searchInputDesktop" placeholder="I am looking for..." class="w-full pl-5 pr-32 py-3 rounded-full border border-gray-300 focus:outline-none focus:border-[#ea580c] bg-white shadow-sm">
                    <button id="searchBtnDesktop" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-[#ea580c]">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    </button>
                </div>
                <button id="aiSearchDesktop" class="ai-search-glow px-6 py-3 bg-white text-[#1f2937] font-semibold rounded-full shadow-sm">
                    Search with AI
                </button>
            </div>
        </div>

        <div class="flex items-center gap-4">
          <button id="cartBtn" class="relative text-gray-800 hover:text-[#ea580c] transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" viewBox="0 0 24 24" fill="currentColor"><path d="M7 4h-2l-1 2H1v2h2l3.6 7.6-1.4 2.4c-.2.3-.2.8 0 1.2.2.4.6.6 1 .6h12v-2H7.4c-.1 0-.2 0-.2-.1l.9-1.5h7.9c.4 0 .7-.2.9-.5l3.6-6.5c.2-.4.1-.8 0-1.1-.2-.3-.5-.5-.9-.5H6.2L5.3 4H7zm0 16c-1.1 0-2 .9-2 2s.9 2 2 2c1.2 0 2-.9 2-2s-.8-2-2-2zm10 0c-1.1 0-2 .9-2 2s.9 2 2 2c1.2 0 2-.9 2-2s-.9-2-2-2z"/></svg>
            <span id="cartCount" class="absolute -top-1 -right-2 bg-[#ea580c] text-white text-xs font-bold px-1.5 py-0.5 rounded-full">0</span>
          </button>
        </div>
    </div>
    
    <div class="md:hidden mt-10 flex gap-2 w-full">
         <div class="relative flex-grow">
            <input type="text" id="searchInputMobile" placeholder="I am looking for..." class="w-full pl-3 pr-8 py-2.5 text-sm rounded-lg border border-gray-300 focus:outline-none focus:border-[#ea580c] bg-white">
            <button id="searchBtnMobile" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
            </button>
         </div>
          <button class="ai-search-glow px-3 py-2.5 text-xs font-bold text-gray-900 bg-white flex items-center gap-1 shadow-sm whitespace-nowrap" id="aiSearchMobile">
         Search with AI
          </button>
    </div>
  </div>
</header>

<nav class="bg-gray-100 border-b">
  <div class="max-w-7xl mx-auto px-4 py-3 text-sm">
    <ol class="flex items-center gap-2 text-gray-600">
      <li><a href="index.html" class="hover:text-[#ea580c]">Home</a></li>
      <li>â€º</li>
      <li><a href="shop.html" class="hover:text-[#ea580c]">Shop</a></li>
      <li id="bcCatWrapper" class="hidden">â€º <a id="bcCatLink" href="#"></a></li>
      <li id="bcSubWrapper" class="hidden">â€º <a id="bcSubLink" href="#" class="text-[#ea580c] font-semibold"></a></li>
    </ol>
  </div>
</nav>

<main class="max-w-7xl mx-auto p-4 md:p-8 space-y-12">
  
  <div id="product-container" class="grid grid-cols-1 md:grid-cols-2 gap-8 lg:gap-12">
      
      <div class="flex flex-col gap-4">
          <div class="zoom-container bg-white aspect-square flex items-center justify-center p-2 md:p-6 shadow-sm">
              <img id="pImg" src="" alt="" class="w-full h-full object-contain cursor-crosshair">
          </div>
          <div id="thumbs" class="flex gap-3 overflow-x-auto pb-2 scrollbar-hide"></div>
      </div>

      <div class="flex flex-col gap-4">
          
          <div class="flex justify-between items-start gap-4">
              <h1 id="pTitle" class="text-2xl md:text-4xl font-bold text-gray-900 leading-tight"></h1>
              <button class="text-gray-400 hover:text-red-500 transition" title="Add to Wishlist">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                  </svg>
              </button>
          </div>

          <div class="flex items-center gap-4 flex-wrap">
               <div class="flex text-yellow-400 text-sm">
                   <svg class="w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                   <svg class="w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                   <svg class="w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                   <svg class="w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                   <svg class="w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="M12 2l2.4 7.2h7.6l-6 4.8 2.4 7.2-6-4.8-6 4.8 2.4-7.2-6-4.8h7.6z"/></svg>
               </div>
               <span class="text-sm font-semibold text-green-600 bg-green-50 px-2 py-1 rounded">(45 sold so far)</span>
          </div>

          <div class="flex items-baseline gap-3 mt-1">
              <span id="pPrice" class="text-4xl font-bold text-[#ea580c]"></span>
              <span id="pOriginal" class="text-xl text-gray-400 line-through"></span>
              <span id="pDisc" class="hidden bg-red-100 text-red-600 text-xs font-bold px-2 py-1 rounded"></span>
          </div>

          <div id="variantBox" class="hidden">
            <label class="block text-sm font-semibold text-gray-700 mb-2">Select Option:</label>
            <div id="variantOptions" class="flex flex-wrap gap-2"></div>
          </div>

          <div class="bg-gray-50 p-4 rounded-lg border border-gray-100 mt-2">
              <h3 class="font-bold text-gray-800 mb-2">Key Features</h3>
              <ul id="featuresList" class="list-disc list-inside text-gray-700 text-sm space-y-1.5 marker:text-[#ea580c]">
                  </ul>
          </div>

          <div>
              <div id="descText" class="text-gray-600 leading-relaxed text-sm overflow-hidden transition-all duration-300" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;"></div>
              <button id="descToggle" class="text-[#ea580c] text-sm font-semibold hover:underline mt-1">Read More</button>
          </div>

          <div class="hidden md:flex gap-4 mt-4">
              <button id="btnCartDesktop" class="flex-1 bg-white border-2 border-[#ea580c] text-[#ea580c] text-lg font-bold py-3 rounded-lg hover:bg-orange-50 transition shadow-sm">
                  Add to Cart
              </button>
              <button id="btnBuyDesktop" class="flex-1 bg-[#ea580c] text-white text-lg font-bold py-3 rounded-lg hover:bg-orange-700 transition shadow-md">
                  Buy Now
              </button>
          </div>

          <div class="flex gap-4 text-xs text-gray-500 mt-2">
              <div class="flex items-center gap-1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                  Verified Quality
              </div>
              <div class="flex items-center gap-1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                  Fast Delivery
              </div>
          </div>
      </div>
  </div>

  <section class="border-t pt-8">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">See what other buyers are saying</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="bg-white p-4 rounded-xl border shadow-sm">
              <div class="flex items-center gap-2 mb-2">
                  <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center font-bold text-gray-500">J</div>
                  <div>
                      <p class="text-sm font-bold">John K.</p>
                      <div class="text-yellow-400 text-xs flex">â˜…â˜…â˜…â˜…â˜…</div>
                  </div>
              </div>
              <p class="text-gray-600 text-sm">"Excellent product! Delivered to Nairobi within 24 hours. Very happy with the quality."</p>
          </div>
          <div class="bg-white p-4 rounded-xl border shadow-sm">
              <div class="flex items-center gap-2 mb-2">
                  <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center font-bold text-gray-500">S</div>
                  <div>
                      <p class="text-sm font-bold">Sarah M.</p>
                      <div class="text-yellow-400 text-xs flex">â˜…â˜…â˜…â˜…â˜†</div>
                  </div>
              </div>
              <p class="text-gray-600 text-sm">"Worth the price. Customer service was very helpful when I had questions."</p>
          </div>
          <div class="bg-white p-4 rounded-xl border shadow-sm">
              <div class="flex items-center gap-2 mb-2">
                  <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center font-bold text-gray-500">D</div>
                  <div>
                      <p class="text-sm font-bold">David O.</p>
                      <div class="text-yellow-400 text-xs flex">â˜…â˜…â˜…â˜…â˜…</div>
                  </div>
              </div>
              <p class="text-gray-600 text-sm">"Genuine item. Works exactly as described. Will buy again."</p>
          </div>
      </div>
  </section>

  <section>
      <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 border-l-4 border-[#ea580c] pl-3">You May Also Like</h2>
      <div id="relGrid" class="horizontal-scroll"></div>
  </section>

  <section>
      <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 border-l-4 border-[#ea580c] pl-3">Customers Bought This Too</h2>
      <div id="upsellGrid" class="horizontal-scroll"></div>
  </section>

</main>

<div class="sticky-mobile-footer">
    <button id="btnCartMobile" class="flex-1 bg-white border border-[#ea580c] text-[#ea580c] font-bold py-3 rounded shadow-sm">
        Add to Cart
    </button>
    <button id="btnBuyMobile" class="flex-1 bg-[#ea580c] text-white font-bold py-3 rounded shadow-sm">
        Buy Now
    </button>
</div>

<footer class="bg-black text-gray-300 mt-10 pb-20 md:pb-0">
  <div class="max-w-7xl mx-auto px-6 py-10 grid grid-cols-1 md:grid-cols-3 gap-6 md:gap-8 items-start">
    <div class="order-1">
      <img src="images/sharkim_gold_logo.png" alt="Company Logo" class="h-24 mb-4 object-contain">
      <p class="mb-2">WhatsApp Us: <a href="https://wa.me/254704843554" class="text-[#ac8334] font-medium">+254 704 843 554</a></p>
    </div>
    <div class="order-2 text-right">
      <h3 class="text-lg font-semibold mb-3 text-white">Secure Payment</h3>
      <div class="flex space-x-3 bg-white p-2 rounded justify-end inline-flex"> 
          <img src="images/mpesa1.png" alt="MPESA" class="h-6 object-contain">
      </div>
      <p class="text-xs text-gray-500 mt-2">&copy; 2025 Sharkim Traders.</p>
    </div>
    <div class="order-3 text-right">
        <h3 class="text-lg font-semibold mb-3 text-white">Quick Links</h3>
        <ul class="space-y-2 text-sm text-right">
          <li><a href="shop.html" class="hover:text-[#ac8334]">Shop All</a></li>
          <li><a href="about.html" class="hover:text-[#ac8334]">About Us</a></li>
          <li><a href="faq.html" class="hover:text-[#ac8334]">FAQ</a></li>
        </ul>
    </div>
  </div>
</footer>

<script>
    // 1. SETUP
   // 1. CONFIGURATION
const SUPABASE_URL = 'https://ljxvxbjhkgoeygpyejkc.supabase.co/';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxqeHZ4Ympoa2dvZXlncHllamtjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1ODE3MzMsImV4cCI6MjA4MzE1NzczM30.fBrwtnv89UHgjs523rKCODE5W4nfBmDsP0AUQ8NgBlU';
const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Get ID from URL
    const params = new URLSearchParams(window.location.search);
    const productId = params.get('id');

    async function loadProduct() {
        if (!productId) return;

        // 2. FETCH MAIN PRODUCT (Including Embedding!)
        const { data: product, error } = await client
            .from('products')
            .select('*, embedding') 
            .eq('id', productId)
            .single();

        if (error || !product) {
            document.body.innerHTML = "<h1 class='text-center mt-10'>Product not found</h1>";
            return;
        }

        renderMainProduct(product);
        loadRelatedProducts(product.embedding, product.id);
    }

    // 3. RENDER MAIN PRODUCT
    function renderMainProduct(p) {
    document.title = `${p.title} - Sharkim Traders`;
    
    // Set Image and Title
    document.getElementById('pImg').src = p.image_url;
    document.getElementById('pImg').alt = p.title;
    document.getElementById('pTitle').textContent = p.title;
    
    // Set Pricing
    document.getElementById('pPrice').textContent = `Ksh ${p.price.toLocaleString()}`;
    if (p.original_price && p.original_price > p.price) {
        const origEl = document.getElementById('pOriginal');
        origEl.textContent = `Ksh ${p.original_price.toLocaleString()}`;
        
        const discEl = document.getElementById('pDisc');
        const pct = Math.round(((p.original_price - p.price) / p.original_price) * 100);
        discEl.textContent = `-${pct}% OFF`;
        discEl.classList.remove('hidden');
    }

    // Set Description and Features
    document.getElementById('descText').textContent = p.description || "No description available.";
    
    const featuresList = document.getElementById('featuresList');
    if (p.features && Array.isArray(p.features)) {
        featuresList.innerHTML = p.features.map(f => `<li>${f}</li>`).join('');
    }

    // Setup Buttons (Desktop & Mobile)
    const handleAdd = () => {
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        let exist = cart.find(x => x.id === p.id);
        if(exist) exist.qty++; else cart.push({ id: p.id, title: p.title, price: p.price, image: p.image_url, qty: 1 });
        localStorage.setItem('cart', JSON.stringify(cart));
        alert('Added to cart!');
    };

    document.getElementById('btnCartDesktop').onclick = handleAdd;
    document.getElementById('btnCartMobile').onclick = handleAdd;
}

  // 4. LOAD RELATED PRODUCTS (VECTOR SEARCH) - UPDATED
async function loadRelatedProducts(embedding, currentId) {
    if (!embedding) return;

    // Use the RPC function created in SQL for vector similarity
    const { data: related, error } = await client.rpc('match_products', {
        query_embedding: embedding, // Search using current product's vector data
        match_threshold: 0.5,       // Adjusted threshold for better variety
        match_count: 8              // Fetching 8 to fill the horizontal scroller
    });

    if (error) {
        console.error("Vector search error:", error);
        return;
    }

    // Target 'relGrid' to match the ID in your product.html
    const container = document.getElementById('relGrid');
    
    if (container && related) {
        container.innerHTML = '';
        
        // Filter out the current product to avoid showing it in recommendations
        const filtered = related.filter(p => p.id !== currentId);
        
        // Map products into the horizontal scroll card format
        container.innerHTML = filtered.map(p => `
            <a href="product.html?id=${p.id}" class="flex-shrink-0 w-48 bg-white border rounded-xl p-3 hover:shadow-md transition">
                <div class="h-32 w-full mb-2">
                    <img src="${p.image_url || 'images/sharkim_gold_logo.png'}" 
                         class="h-full w-full object-contain" 
                         loading="lazy">
                </div>
                <h4 class="text-xs font-bold line-clamp-2 h-8 text-gray-800">${p.title}</h4>
                <div class="mt-1">
                    <span class="text-[#ea580c] font-bold text-sm">Ksh ${(p.price || 0).toLocaleString()}</span>
                </div>
            </a>
        `).join('');
    }
}
// =====================
// NEW: AI Search Logic
// =====================

// 1. Safe Helper to ensure UI exists before use
// 1. Safe Helper - Made more aggressive
function ensureAiUiExists() {
    let modal = document.getElementById('ai-search-modal');
    if (!modal) {
        console.time("UI_Injection_Speed"); // Start timer
        injectAiUi();
        modal = document.getElementById('ai-search-modal');
        console.timeEnd("UI_Injection_Speed"); // See how long injection took
    }
    return modal;
}

// 2. Move the call OUTSIDE of any event listeners

injectAiUi(); 

// Update your DOMContentLoaded to just fetch products
document.addEventListener('DOMContentLoaded', () => {
    console.log("LOG: DOM fully loaded and parsed");
    fetchProducts();
});

// 2. The Trigger Function
async function handleAiSearch(query) {
    if (!query) return;

    // Ensure UI is ready
    const modal = ensureAiUiExists();
    const chatContainer = document.getElementById('ai-chat-container');

    // Double check container exists to prevent "appendChild of null"
    if (!modal || !chatContainer) {
        console.error("AI Search UI could not be initialized.");
        return;
    }

    // Show the modal
    modal.classList.remove('hidden');
    
    // Add user text
    addChatMessage('user', query);
    const loadingId = addLoadingIndicator();

    try {
        // Call the Edge Function
        const { data, error } = await client.functions.invoke('ai-search', {
            body: { 
                query: query, 
                history: searchHistory,
            }
        });

        if (error) throw error;

        removeLoadingIndicator(loadingId);

        if (data && data.refined_products) {
            // Show AI response + Horizontal Scroll
            addAiResponse(data.pre_text, data.refined_products);
            
            // Save context for "Refine Search"
            searchHistory.push({ role: 'user', content: query });
            searchHistory.push({ 
                role: 'assistant', 
                content: data.pre_text, 
                product_ids: data.refined_products.map(p => p.id) 
            });
        }
    } catch (err) {
        removeLoadingIndicator(loadingId);
        // Fallback if chatContainer disappeared
        const container = document.getElementById('ai-chat-container');
        if (container) {
            addChatMessage('ai', "I'm having trouble connecting to the network. Please try again.");
        }
        console.error("Edge Function Error:", err);
    }
}

// 3. Updated Event Listeners
// These match the IDs in your index.html exactly
const searchConfig = [
    { btn: 'searchBtnDesktop', input: 'searchInputDesktop' },
    { btn: 'searchBtnMobile', input: 'searchInputMobile' },
    { btn: 'aiSearchDesktop', input: 'searchInputDesktop' },
    { btn: 'aiSearchMobile', input: 'searchInputMobile' }
];

searchConfig.forEach(({ btn, input }) => {
    const btnEl = document.getElementById(btn);
    const inputEl = document.getElementById(input);
    
    if (btnEl) {
        // Clone to clear old keyword-search listeners
        const newBtn = btnEl.cloneNode(true);
        btnEl.parentNode.replaceChild(newBtn, btnEl);

        newBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const val = inputEl ? inputEl.value.trim() : '';
            
            // Ensure UI is ready immediately on click
            const modal = ensureAiUiExists();

            if (val) {
                handleAiSearch(val);
                if(inputEl) inputEl.value = ''; 
            } else if (modal) {
                // If empty, just open the AI chat modal
                modal.classList.remove('hidden');
            }
        });
    }
});
// =====================
// UI HELPER FUNCTIONS
// =====================

// Generates HTML for a Single Product Card
function createProductCard(p, isHorizontal = false) {
    const card = document.createElement('div');
    
    // Different styles for Homepage Grid vs AI Horizontal Scroll
    const wrapperClass = isHorizontal 
        ? "min-w-[260px] w-[260px] snap-center bg-white border rounded-lg shadow-sm flex-shrink-0 mr-4"
        : "bg-white border rounded-lg shadow-sm hover:shadow-md transition relative";
    
    card.className = wrapperClass;
    
    // Logic for Image: specific to your new DB schema (image_url)
    // Also handles the "In Stock" badge
    const stockBadge = (p.stock_quantity && p.stock_quantity > 0) 
        ? '<span class="absolute top-2 right-2 bg-green-100 text-green-800 text-xs px-2 py-1 rounded z-10">In Stock</span>' 
        : '';

    card.innerHTML = `
      <a href="product.html?id=${p.id}" class="block h-full flex flex-col">
        <div class="h-48 p-4 flex items-center justify-center relative">
           ${stockBadge}
           <img src="${p.image_url || 'placeholder.jpg'}" class="h-full object-contain mx-auto" loading="lazy" alt="${p.title}">
        </div>
        <div class="p-4 border-t flex-1 flex flex-col justify-between">
          <div>
            <h3 class="text-sm font-bold text-gray-800 line-clamp-2 mb-2">${p.title}</h3>
            <div class="text-xs text-gray-500 line-through">${p.original_price ? 'Ksh ' + p.original_price : ''}</div>
            <div class="text-[#ea580c] font-bold text-lg">Ksh ${p.price}</div>
          </div>
        </div>
      </a>
    `;
    return card;
}

// Injects the Hidden AI Modal into HTML
function injectAiUi() {
    if (document.getElementById('ai-search-modal')) return; // Don't create twice

    const div = document.createElement('div');
    div.id = 'ai-search-modal';
    div.className = 'fixed inset-0 bg-black/60 z-[9999] hidden flex flex-col justify-end sm:justify-center items-center backdrop-blur-sm transition-all';
    div.innerHTML = `
      <div class="bg-gray-50 w-full max-w-2xl h-[85vh] sm:h-[80vh] sm:rounded-xl shadow-2xl flex flex-col overflow-hidden animate-slide-up">
        <div class="p-4 bg-white border-b flex justify-between items-center shadow-sm">
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                <h2 class="font-bold text-gray-800">AI Assistant</h2>
            </div>
            <button onclick="document.getElementById('ai-search-modal').classList.add('hidden')" class="p-2 hover:bg-gray-100 rounded-full transition">
                <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <div id="ai-chat-container" class="flex-1 overflow-y-auto p-4 space-y-6 scroll-smooth">
            <div class="text-center text-gray-400 text-sm mt-10">
                <p class="mb-2">Try searching for:</p>
                <span class="inline-block bg-white px-3 py-1 rounded-full border text-xs m-1">"Cheap phones 128gb"</span>
                <span class="inline-block bg-white px-3 py-1 rounded-full border text-xs m-1">"Laptops for gaming"</span>
            </div>
        </div>

        <div class="p-3 bg-white border-t">
            <div class="flex gap-2 relative">
                <input id="ai-refine-input" type="text" placeholder="Refine results... (e.g. 'Under 40k')" 
                    class="w-full pl-4 pr-12 py-3 border rounded-full focus:outline-none focus:ring-2 focus:ring-black text-sm shadow-sm"
                    onkeypress="if(event.key === 'Enter') document.getElementById('ai-send-btn').click()">
                <button id="ai-send-btn" class="absolute right-2 top-1.5 bg-black text-white p-2 rounded-full hover:bg-gray-800 transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"></path></svg>
                </button>
            </div>
        </div>
      </div>
    `;
    document.body.appendChild(div);

    // Refine Button Logic
    document.getElementById('ai-send-btn').addEventListener('click', () => {
        const input = document.getElementById('ai-refine-input');
        const val = input.value.trim();
        if(val) {
            handleAiSearch(val); // Re-runs search with history
            input.value = '';
        }
    });
}

// Chat UI Helpers
function addChatMessage(role, text) {
    const container = document.getElementById('ai-chat-container');
    const div = document.createElement('div');
    div.className = role === 'user' ? 'flex justify-end' : 'flex justify-start';
    div.innerHTML = `
        <div class="${role === 'user' ? 'bg-black text-white' : 'bg-white border text-gray-800'} px-5 py-2.5 rounded-2xl max-w-[85%] text-sm shadow-sm">
            ${text}
        </div>
    `;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
}

function addAiResponse(preText, products) {
    const container = document.getElementById('ai-chat-container');
    
    const msgDiv = document.createElement('div');
    msgDiv.className = 'flex flex-col items-start gap-3 max-w-full w-full';
    msgDiv.innerHTML = `
        <div class="bg-white border px-5 py-3 rounded-2xl rounded-tl-none text-gray-800 text-sm shadow-sm">
            ${preText}
        </div>
    `;
    
    if (products.length > 0) {
        const carousel = document.createElement('div');
        carousel.className = 'flex overflow-x-auto space-x-4 w-full py-2 pb-4 snap-x hide-scrollbar px-1';
        products.forEach(p => {
            carousel.appendChild(createProductCard(p, true)); // True = Horizontal Style
        });
        msgDiv.appendChild(carousel);
    }

    container.appendChild(msgDiv);
    container.scrollTop = container.scrollHeight;
}

function addLoadingIndicator() {
    const id = 'loading-' + Date.now();
    const container = document.getElementById('ai-chat-container');
    const div = document.createElement('div');
    div.id = id;
    div.className = 'flex justify-start';
    div.innerHTML = `
        <div class="bg-gray-100 px-4 py-2 rounded-2xl rounded-tl-none text-xs text-gray-500 flex items-center gap-2">
            <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></span>
            <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></span>
            <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
        </div>
    `;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
    return id;
}

function removeLoadingIndicator(id) {
    const el = document.getElementById(id);
    if(el) el.remove();
}
function initLazyLoader() {
    const target = document.getElementById('youMayLikeRow1');
    if (!target) return;

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                console.log("LOG: User reached bottom section, rendering remaining products...");
                renderBottomRows();
                observer.unobserve(target); // Stop observing once rendered
            }
        });
    }, { rootMargin: '200px' }); // Start loading 200px before the user sees it

    observer.observe(target);
}

function renderBottomRows() {
    const row1 = document.getElementById('youMayLikeRow1');
    const row2 = document.getElementById('youMayLikeRow2');
    if (!row1 || !row2) return;

    const shuffled = [...allProducts].sort(() => 0.5 - Math.random()).slice(4, 24);
    
    shuffled.forEach((p, i) => {
        const card = renderCard(p, true);
        card.classList.add('animate-fade-in'); // Add a nice fade effect
        if (i % 2 === 0) row1.appendChild(card);
        else row2.appendChild(card);
    });
}
    loadProduct();
</script>
</body>
</html>