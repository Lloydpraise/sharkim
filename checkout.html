<!DOCTYPE html>
<html lang="en">
<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17577238441"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'AW-17577238441');
  </script>
<script>
function gtag_report_conversion(url, value, transaction_id) {
  var callback = function () {
    if (typeof(url) != 'undefined') {
      window.location = url;
    }
  };
  gtag('event', 'conversion', {
      'send_to': 'AW-17577238441/ItUjCNeUnfEbEKm_vb1B',
      'value': value,
      'currency': 'KES',
      'transaction_id': transaction_id,
      'event_callback': callback
  });
  return false;
}
</script>
<!-- Meta Pixel Code -->
<script>
!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '1815039102579831');
fbq('track', 'PageView');
</script>
<noscript><img height="1" width="1" style="display:none"
src="https://www.facebook.com/tr?id=1815039102579831&ev=PageView&noscript=1"
/></noscript>
<!-- End Meta Pixel Code -->
  
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="images/icon%20logo.png">
  <title>Checkout - Sharkim Traders</title>
  
  <script src="https://cdn.tailwindcss.com/"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  
  <style>
    /* Global Font & Body */
    html, body { 
        max-width: 100%; 
        overflow-x: hidden; 
        font-family: "Times New Roman", Times, serif, Arial, Helvetica, sans-serif; 
        background-color: #f3f4f6; /* Matching index bg */
    }
    
    /* Brand Colors */
    .brand-orange { color: #ea580c; }
    .bg-brand-orange { background-color: #ea580c; }
    .brand-green { background-color: #25D366; }

    /* Header Styling */
    .header-bg { background-color: #f3f4f6; }

    /* Animated Title Underline (From Index) */
    .title-underline {
      position: relative;
      display: inline-block;
      padding-bottom: 8px;
    }
    .title-underline::after {
      content: '';
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: -8px;
      width: 80px;
      height: 4px;
      border-radius: 6px;
      background: linear-gradient(90deg, #ac8334, #f59e0b, #ac8334);
      background-size: 200% 100%;
      animation: gradientMove 3s linear infinite;
    }
    @keyframes gradientMove { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

    /* Form & Card Styling */
    .step-number {
        background-color: #ea580c; 
        color: white;
    }
    
    /* Delivery Option Selected State */
    .delivery-option.selected {
        border-color: #ea580c;
        background-color: #fff7ed; /* orange-50 */
        position: relative;
    }
    .delivery-option.selected::after {
        content: 'âœ”';
        position: absolute;
        top: -8px;
        right: -8px;
        background: #ea580c;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* Modal Animation */
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
  </style>
</head>

<body class="min-h-screen flex flex-col text-gray-800">

<header class="header-bg py-4 shadow-sm sticky top-0 z-40">
  <div class="max-w-5xl mx-auto px-4 flex items-center justify-between relative">
    <a href="index.html" class="flex-shrink-0">
      <img src="images/sharkim_gold_logo.png" alt="Sharkim Logo" class="h-12 md:h-16 object-contain">
    </a>
    
    <div class="absolute left-1/2 transform -translate-x-1/2">
        <h1 class="text-2xl md:text-3xl font-bold text-gray-800"><span class="title-underline">Checkout</span></h1>
    </div>
    
    <div class="w-12"></div>
  </div>
</header>

<main class="flex-grow max-w-5xl mx-auto w-full px-4 py-8 space-y-6">

    <div class="grid grid-cols-1 md:grid-cols-12 gap-8">
        
        <div class="md:col-span-7 space-y-6">
            
            <section class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                <h2 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Products Ordered</h2>
                <div id="checkoutItemsList" class="space-y-4">
                    </div>
                <div class="mt-4 pt-3 border-t border-gray-100">
                    <button onclick="window.location.href='shop.html'" class="text-sm text-[#ea580c] hover:text-orange-700 font-medium hover:underline transition">
                        Add another Product? Click Here
                    </button>
                </div>
            </section>

            <section class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <span class="step-number w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold">1</span>
                    Contact Information
                </h2>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">First Name</label>
                            <input type="text" id="custFirstName" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-[#ea580c] bg-gray-50 focus:bg-white transition" placeholder="First name">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">Last Name</label>
                            <input type="text" id="custLastName" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-[#ea580c] bg-gray-50 focus:bg-white transition" placeholder="Last name">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Phone Number</label>
                        <input type="tel" id="custPhone" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-[#ea580c] bg-gray-50 focus:bg-white transition" placeholder="07...">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Email</label>
                        <input type="email" id="custEmail" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-[#ea580c] bg-gray-50 focus:bg-white transition" placeholder="your@email.com">
                    </div>
                </div>
            </section>

            <section class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <span class="step-number w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold">2</span>
                    Shipping Information
                </h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Country</label>
                        <select id="custCountry" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-[#ea580c] bg-gray-50 focus:bg-white transition">
                            <option value="Kenya" selected>Kenya</option>
                            <option value="Tanzania">Tanzania</option>
                            <option value="Uganda">Uganda</option>
                            <option value="Rwanda">Rwanda</option>
                            <option value="Burundi">Burundi</option>
                            <option value="South Sudan">South Sudan</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">City</label>
                        <input type="text" id="custCity" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-[#ea580c] bg-gray-50 focus:bg-white transition" placeholder="e.g., Nairobi">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Estate / Area</label>
                        <input type="text" id="custEstate" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-[#ea580c] bg-gray-50 focus:bg-white transition" placeholder="e.g., Westlands">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Delivery Location / Landmark</label>
                        <input type="text" id="custLocation" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-[#ea580c] bg-gray-50 focus:bg-white transition" placeholder="e.g., Juja City Mall, Kiambu">
                    </div>
                </div>
            </section>

            <section class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <span class="step-number w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold">3</span>
                    Delivery Method
                </h2>
                <div class="grid grid-cols-2 gap-3">
                    
                    <button onclick="selectDelivery(0, 'Pickup Point', this)" class="delivery-option p-3 border-2 border-gray-100 rounded-xl text-left hover:border-gray-300 transition group flex flex-col justify-between h-full">
                        <div>
                            <div class="font-bold text-sm text-gray-800">PickUp from Shop</div>
                            <div class="text-xs text-gray-500 mt-1">Nairobi CBD</div>
                        </div>
                        <div class="mt-2 font-bold text-[#ea580c] text-sm">Free</div>
                    </button>

                    <button onclick="selectDelivery(300, 'Rider Delivery', this)" class="delivery-option p-3 border-2 border-gray-100 rounded-xl text-left hover:border-gray-300 transition group flex flex-col justify-between h-full">
                        <div>
                            <div class="font-bold text-sm text-gray-800">Rider</div>
                            <div class="text-xs text-gray-500 mt-1">Nairobi Environs</div>
                        </div>
                        <div class="mt-2 font-bold text-[#ea580c] text-sm">Ksh 300</div>
                    </button>

                    <button onclick="selectDelivery(400, 'Outside Nairobi', this)" class="delivery-option p-3 border-2 border-gray-100 rounded-xl text-left hover:border-gray-300 transition group flex flex-col justify-between h-full">
                        <div>
                            <div class="font-bold text-sm text-gray-800">Out of Nairobi</div>
                            <div class="text-xs text-gray-500 mt-1">Courier/Parcel</div>
                        </div>
                        <div class="mt-2 font-bold text-[#ea580c] text-sm">Ksh 400</div>
                    </button>

                </div>
            </section>
        </div>

        <div class="md:col-span-5 space-y-6">
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 sticky top-24">
                <h2 class="text-xl font-bold text-gray-800 mb-6 border-b pb-4">Order Summary</h2>

                <div class="space-y-3 text-sm">
                    <div class="flex justify-between text-gray-600">
                        <span>Items Subtotal</span>
                        <span class="font-bold text-gray-800">Ksh <span id="summarySubtotal">0</span></span>
                    </div>
                    <div class="flex justify-between text-gray-600">
                        <span>Delivery Fee</span>
                        <span class="font-bold text-gray-800">Ksh <span id="summaryShipping">0</span></span>
                    </div>
                    <div id="summarySavings" class="hidden flex justify-between text-green-600 font-bold bg-green-50 p-2 rounded">
                        <span>Discount Savings</span>
                        <span>- Ksh <span id="savingsValue">0</span></span>
                    </div>
                </div>

                <div class="flex justify-between items-center border-t border-dashed border-gray-300 mt-4 pt-4 mb-6">
                    <span class="text-lg font-bold text-gray-800">Total Payable</span>
                    <span class="text-3xl font-extrabold text-[#ea580c]">Ksh <span id="summaryTotal">0</span></span>
                </div>
                
                <div class="space-y-4">
                    <button onclick="processPayment()" class="w-full py-4 bg-[#ea580c] hover:bg-orange-700 text-white rounded-xl font-bold shadow-md transition flex items-center justify-center gap-2 group hidden">
                        <span>Continue to Payment</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                    </button>

                    <button onclick="processWhatsAppCheckout()" class="w-full py-4 bg-[#25D366] hover:bg-green-600 text-white rounded-xl font-bold shadow-md transition flex items-center justify-center gap-2">
                        <svg class="w-6 h-6 fill-current" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
                        Complete on WhatsApp
                    </button>
                    
                    <div class="flex items-center justify-center gap-2 mt-4 opacity-70">
                        <img src="images/mpesa1.png" class="h-6" alt="Mpesa">
                        <img src="images/equity.png" class="h-6" alt="Equity">
                    </div>
                </div>
            </div>
            
            <div class="space-y-3 pt-4">
                <details class="bg-white rounded-lg shadow-sm border border-gray-100 group">
                    <summary class="flex justify-between items-center p-3 cursor-pointer font-semibold text-sm text-gray-700 hover:text-[#ea580c] transition">
                        <span>Shipping and Delivery Policy</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-gray-400 transition-transform group-open:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </summary>
                    <div class="px-3 pb-3 text-gray-500 text-xs leading-relaxed border-t mt-2 pt-2">
                        Orders within Nairobi are delivered via riders typically within 24 hours. Orders outside Nairobi are dispatched via trusted courier partners (Wells Fargo, G4S, or PSV parcels). Pickup options available at CBD.
                    </div>
                </details>

                <details class="bg-white rounded-lg shadow-sm border border-gray-100 group">
                    <summary class="flex justify-between items-center p-3 cursor-pointer font-semibold text-sm text-gray-700 hover:text-[#ea580c] transition">
                        <span>Returns and Refunds</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-gray-400 transition-transform group-open:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </summary>
                    <div class="px-3 pb-3 text-gray-500 text-xs leading-relaxed border-t mt-2 pt-2">
                        We accept returns for items with manufacturing defects within 48 hours. Items must be unused and in original packaging. Refunds processed within 5 business days.
                    </div>
                </details>
            </div>
        </div>
    </div>
</main>

<div id="authModal" class="fixed inset-0 z-50 hidden flex items-center justify-center animate-fade-in">
    <div class="absolute inset-0 bg-black bg-opacity-70 backdrop-blur-sm"></div>
    <div class="bg-white w-11/12 max-w-md p-8 rounded-2xl shadow-2xl relative z-10 text-center">
        
        <h2 class="text-2xl font-bold text-gray-800 mb-2">Create an account with us</h2>
        <p class="text-gray-500 mb-6 text-sm">Enter your details to speed up checkout.</p>
        
        <div class="space-y-4 text-left">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-bold text-gray-700 ml-1 mb-1">First Name</label>
                    <input type="text" id="modalFirstName" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:border-[#ea580c] focus:outline-none transition" placeholder="First name">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 ml-1 mb-1">Last Name</label>
                    <input type="text" id="modalLastName" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:border-[#ea580c] focus:outline-none transition" placeholder="Last name">
                </div>
            </div>
            <div>
                <label class="block text-sm font-bold text-gray-700 ml-1 mb-1">Phone Number</label>
                <input type="tel" id="modalPhone" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:border-[#ea580c] focus:outline-none transition" placeholder="07...">
                <p class="text-xs text-gray-400 mt-1 ml-1">We'll use this for order updates.</p>
            </div>
            <div>
                <label class="block text-sm font-bold text-gray-700 ml-1 mb-1">Email</label>
                <input type="email" id="modalEmail" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:border-[#ea580c] focus:outline-none transition" placeholder="your@email.com">
            </div>
        </div>

        <div class="flex items-center justify-between mt-8">
            <button onclick="skipLogin()" class="text-gray-400 text-sm hover:text-gray-600 transition font-medium px-2">
                Skip for now
            </button>
            <button onclick="handleLogin()" class="px-8 py-3 bg-[#ea580c] hover:bg-orange-700 text-white font-bold rounded-lg shadow-md transition transform active:scale-95">
                Sign Up / Login
            </button>
        </div>
    </div>
</div>

<div id="paymentModal" class="fixed inset-0 z-50 hidden flex items-center justify-center animate-fade-in">
    <div class="absolute inset-0 bg-black bg-opacity-70 backdrop-blur-sm"></div>
    <div class="bg-white w-11/12 max-w-md p-6 rounded-2xl shadow-2xl relative z-10">
        
        <div class="text-center mb-4">
            <h2 class="text-xl font-bold text-gray-800">Select Payment Method</h2>
            <p class="text-xs text-gray-500">Your order has been recorded. Please pay to complete.</p>
        </div>

        <div class="bg-orange-50 border border-orange-100 rounded-xl p-3 text-center mb-4">
            <p class="text-[10px] uppercase font-bold text-gray-400">Total Payable</p>
            <p class="text-2xl font-black text-[#ea580c]">Ksh <span id="modalTotalAmount">0</span></p>
        </div>

        <div class="grid grid-cols-3 gap-2 mb-6">
            <button onclick="switchMethod('mpesa')" id="tab-mpesa" class="payment-tab p-2 border-2 rounded-xl flex flex-col items-center gap-1 border-[#ea580c] bg-orange-50">
                <img src="images/mpesa1.png" class="h-5 object-contain" alt="Mpesa">
                <span class="text-[10px] font-bold">M-Pesa</span>
            </button>
            <button onclick="switchMethod('equity')" id="tab-equity" class="payment-tab p-2 border-2 border-gray-100 rounded-xl flex flex-col items-center gap-1">
                <img src="images/equity.png" class="h-5 object-contain" alt="Equity">
                <span class="text-[10px] font-bold text-gray-600">Equity</span>
            </button>
            <button onclick="switchMethod('im')" id="tab-im" class="payment-tab p-2 border-2 border-gray-100 rounded-xl flex flex-col items-center gap-1">
                <div class="h-5 flex items-center font-black text-blue-900 text-xs italic">I&M Bank</div>
                <span class="text-[10px] font-bold text-gray-600">I&M</span>
            </button>
        </div>

        <div id="method-details" class="bg-gray-50 p-4 rounded-xl border border-gray-200 mb-6 min-h-[120px]">
            <div id="detail-mpesa" class="method-detail space-y-1">
                <p class="text-xs font-bold text-gray-800 underline mb-2">Lipa Na M-Pesa Instructions:</p>
                <p class="text-xs text-gray-600">1. Go to M-Pesa > Lipa na M-Pesa</p>
                <p class="text-xs text-gray-600">2. Select **Paybill**</p>
                <p class="text-xs text-gray-800 font-medium">3. Business No: <span class="bg-yellow-100 px-1">247247</span></p>
                <p class="text-xs text-gray-800 font-medium">4. Account No: <span class="bg-yellow-100 px-1">843554</span></p>
            </div>
            <div id="detail-equity" class="method-detail hidden space-y-1">
                <p class="text-xs font-bold text-gray-800 underline mb-2">Equity Bank Instructions:</p>
                <p class="text-xs text-gray-600">1. Send money to Equity Bank Paybill 247247</p>
                <p class="text-xs text-gray-800 font-medium">2. Account: <span class="bg-yellow-100 px-1">843554</span></p>
                <p class="text-xs text-gray-800 font-medium">3. Name: <span class="bg-yellow-100 px-1">Sharkim Traders</span></p>
            </div>
            <div id="detail-im" class="method-detail hidden space-y-1">
                <p class="text-xs font-bold text-gray-800 underline mb-2">I&M Bank Instructions:</p>
                <p class="text-xs text-gray-600">1. Transfer to I&M Bank</p>
                <p class="text-xs text-gray-800 font-medium">2. Account: <span class="bg-yellow-100 px-1">Paybill Number: 542542  ACCount Number : 843554</span></p>
                <p class="text-xs text-gray-800 font-medium">3. Name: <span class="bg-yellow-100 px-1">Sharkim Traders</span></p>
            </div>
        </div>

        <div class="space-y-3">
            <button onclick="handlePaid()" class="w-full py-4 bg-[#ea580c] hover:bg-orange-700 text-white font-bold rounded-xl shadow-md transition flex items-center justify-center gap-2">
                <span>I Have Paid</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
            </button>
            <button onclick="document.getElementById('paymentModal').classList.add('hidden')" class="w-full py-2 text-gray-400 text-[10px] uppercase font-bold tracking-widest hover:text-gray-600 transition">
                Close
            </button>
        </div>
    </div>
</div>

<footer class="bg-black text-[#ac8334] text-center py-6 mt-12 border-t border-gray-800">
    <p class="text-sm">&copy; 2025 Sharkim Traders. All rights reserved.</p>
</footer>

<script>
// ==========================
// 1. DATA INITIALIZATION
// ==========================
let cart = JSON.parse(localStorage.getItem('cart') || '[]');
let shippingCost = 0;
let shippingMethod = '';
let checkoutSessionId = null;

const _params = new URLSearchParams(window.location.search);
const _sessionParam = _params.get('cart') || _params.get('session');
if((!cart || cart.length === 0) && _sessionParam) {
    const sessions = JSON.parse(localStorage.getItem('checkout_sessions') || '{}');
    const sess = sessions[_sessionParam];
    if(sess && Array.isArray(sess.cart) && sess.cart.length > 0) {
        cart = sess.cart;
        shippingCost = sess.shippingCost || 0;
        shippingMethod = sess.shippingMethod || '';
        checkoutSessionId = _sessionParam;
        localStorage.setItem('cart', JSON.stringify(cart));
    }
}

if(!cart || cart.length === 0) {
    alert("Your cart is empty. Redirecting to shop.");
    window.location.href = 'shop.html';
}

window.addEventListener('load', () => {
    logCheckoutEvent('checkout_start');
});

// ==========================
// 2. AUTH MODAL LOGIC
// ==========================
const authModal = document.getElementById('authModal');
const userKey = 'sharkim_user';
const savedUser = JSON.parse(localStorage.getItem(userKey));

if (!savedUser) {
    authModal.classList.remove('hidden');
} else {
    document.getElementById('custFirstName').value = savedUser.firstName || '';
    document.getElementById('custLastName').value = savedUser.lastName || '';
    document.getElementById('custPhone').value = savedUser.phone || '';
    document.getElementById('custEmail').value = savedUser.email || '';
}

function handleLogin() {
    const firstName = document.getElementById('modalFirstName').value.trim();
    const lastName = document.getElementById('modalLastName').value.trim();
    const phone = document.getElementById('modalPhone').value.trim();
    const email = document.getElementById('modalEmail').value.trim();

    if (!firstName || !lastName || !phone || !email) {
        alert("Please enter First Name, Last Name, Phone Number, and Email.");
        return;
    }

    // Email validation
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        alert("Please enter a valid email address.");
        return;
    }

    const user = { firstName, lastName, name: `${firstName} ${lastName}`, phone, email };
    localStorage.setItem(userKey, JSON.stringify(user));

    try {
        if (checkoutSessionId) {
            const sessions = JSON.parse(localStorage.getItem('checkout_sessions') || '{}');
            sessions[checkoutSessionId] = sessions[checkoutSessionId] || {};
            sessions[checkoutSessionId].user = user;
            sessions[checkoutSessionId].updatedAt = Date.now();
            localStorage.setItem('checkout_sessions', JSON.stringify(sessions));
        }
    } catch(e) {}

    document.getElementById('custFirstName').value = firstName;
    document.getElementById('custLastName').value = lastName;
    document.getElementById('custPhone').value = phone;
    document.getElementById('custEmail').value = email;
    authModal.classList.add('hidden');
}

function skipLogin() {
    authModal.classList.add('hidden');
}

// ==========================
// 3. CART RENDERING
// ==========================
function renderCheckoutItems() {
    const container = document.getElementById('checkoutItemsList');
    let subtotal = 0;
    let totalSavings = 0;
    
    container.innerHTML = '';

    cart.forEach(item => {
        const qty = item.qty || 1;
        const price = Number(item.price);
        const origPrice = Number(item.original_price) || 0;
        
        subtotal += price * qty;
        if(origPrice > price) {
            totalSavings += (origPrice - price) * qty;
        }

        const row = document.createElement('div');
        // Card Style Matching Cart Drawer (Image Left, Details Right)
        row.className = 'flex gap-3 items-start border-b border-gray-50 last:border-0 pb-3 last:pb-0';
        row.innerHTML = `
            <div class="relative w-20 h-20 border border-gray-200 rounded-lg bg-white flex-shrink-0 overflow-hidden">
                <img src="${item.image_url}" class="w-full h-full object-contain" alt="${item.title}">
            </div>
            <div class="flex-1 min-w-0 flex flex-col justify-between h-20 py-1">
                <p class="text-sm font-bold text-gray-800 line-clamp-2 leading-tight">${item.title}</p>
                <div>
                    ${origPrice > price ? `<span class="text-xs text-gray-400 line-through mr-2">Ksh ${origPrice.toLocaleString()}</span>` : ''}
                    <span class="font-bold text-[#ea580c] text-sm">Ksh ${price.toLocaleString()}</span>
                </div>
            </div>
            <div class="flex flex-col items-end gap-2">
                <button onclick="removeItem(${cart.indexOf(item)})" class="text-orange-500 hover:text-orange-700 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
                <div class="flex items-center gap-2">
                    <button onclick="changeQuantity(${cart.indexOf(item)}, -1)" class="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded-full flex items-center justify-center text-sm font-bold">-</button>
                    <span class="text-sm font-bold min-w-[20px] text-center">${qty}</span>
                    <button onclick="changeQuantity(${cart.indexOf(item)}, 1)" class="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded-full flex items-center justify-center text-sm font-bold">+</button>
                </div>
            </div>
        `;
        container.appendChild(row);
    });

    document.getElementById('summarySubtotal').innerText = subtotal.toLocaleString();
    
    if(totalSavings > 0){
        document.getElementById('summarySavings').classList.remove('hidden');
        document.getElementById('savingsValue').innerText = totalSavings.toLocaleString();
    }
    
    updateTotal(subtotal);

    // Track InitiateCheckout Event for Meta Pixel
    const total = subtotal + shippingCost;
    fbq('track', 'InitiateCheckout', {content_ids: cart.map(item => item.id), value: total, currency: 'KES'});
}

// ==========================
// 3.5 QUANTITY AND REMOVE FUNCTIONS
// ==========================
function changeQuantity(index, delta) {
    if (cart[index]) {
        cart[index].qty = Math.max(1, (cart[index].qty || 1) + delta);
        localStorage.setItem('cart', JSON.stringify(cart));
        renderCheckoutItems();
        
        try {
            if (checkoutSessionId) {
                const sessions = JSON.parse(localStorage.getItem('checkout_sessions') || '{}');
                sessions[checkoutSessionId] = sessions[checkoutSessionId] || {};
                sessions[checkoutSessionId].cart = cart;
                sessions[checkoutSessionId].updatedAt = Date.now();
                localStorage.setItem('checkout_sessions', JSON.stringify(sessions));
            }
        } catch(e) {}
    }
}

function removeItem(index) {
    if (cart[index]) {
        cart.splice(index, 1);
        localStorage.setItem('cart', JSON.stringify(cart));
        renderCheckoutItems();
        
        if (cart.length === 0) {
            alert("Your cart is empty. Redirecting to shop.");
            window.location.href = 'shop.html';
        }
        
        try {
            if (checkoutSessionId) {
                const sessions = JSON.parse(localStorage.getItem('checkout_sessions') || '{}');
                sessions[checkoutSessionId] = sessions[checkoutSessionId] || {};
                sessions[checkoutSessionId].cart = cart;
                sessions[checkoutSessionId].updatedAt = Date.now();
                localStorage.setItem('checkout_sessions', JSON.stringify(sessions));
            }
        } catch(e) {}
    }
}

// ==========================
// 4. SHIPPING LOGIC
// ==========================
function selectDelivery(cost, name, btnElement) {
    shippingCost = cost;
    shippingMethod = name;

    document.querySelectorAll('.delivery-option').forEach(btn => {
        btn.classList.remove('selected');
    });
    btnElement.classList.add('selected');

    document.getElementById('summaryShipping').innerText = cost.toLocaleString();
    
    let subtotal = 0;
    cart.forEach(item => subtotal += (Number(item.price) * (item.qty || 1)));
    updateTotal(subtotal);

    try {
        if (checkoutSessionId) {
            const sessions = JSON.parse(localStorage.getItem('checkout_sessions') || '{}');
            sessions[checkoutSessionId] = sessions[checkoutSessionId] || {};
            sessions[checkoutSessionId].shippingCost = shippingCost;
            sessions[checkoutSessionId].shippingMethod = shippingMethod;
            sessions[checkoutSessionId].updatedAt = Date.now();
            localStorage.setItem('checkout_sessions', JSON.stringify(sessions));
        }
    } catch(e) {}
}

function updateTotal(subtotal) {
    const total = subtotal + shippingCost;
    document.getElementById('summaryTotal').innerText = total.toLocaleString();
}

renderCheckoutItems();

// ==========================
// 5. ACTION BUTTONS LOGIC
// ==========================
function validateForm() {
    const firstName = document.getElementById('custFirstName').value.trim();
    const lastName = document.getElementById('custLastName').value.trim();
    const phone = document.getElementById('custPhone').value.trim();
    const email = document.getElementById('custEmail').value.trim();
    const country = document.getElementById('custCountry').value.trim();
    const city = document.getElementById('custCity').value.trim();
    const estate = document.getElementById('custEstate').value.trim();
    const loc = document.getElementById('custLocation').value.trim();

    if (!firstName || !lastName || !phone || !email || !country || !city || !estate || !loc) {
        alert("Please fill in all required fields: First Name, Last Name, Phone, Email, Country, City, Estate/Area, and Delivery Location.");
        return false;
    }
    
    // Email validation
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        alert("Please enter a valid email address.");
        return false;
    }
    
    if (!shippingMethod) {
        alert("Please select a Delivery Method.");
        return false;
    }
    
    return { firstName, lastName, name: `${firstName} ${lastName}`, phone, email, country, city, estate, loc };
}

async function processWhatsAppCheckout() {
    logCheckoutEvent('whatsapp_click');
    const data = validateForm();
    if (!data) return;

    // 1. Generate a short unique Order Number (e.g., SHA-1234)
    const orderRef = "SHA-" + Math.floor(1000 + Math.random() * 9000);

    try {
        if (checkoutSessionId) {
            const sessions = JSON.parse(localStorage.getItem('checkout_sessions') || '{}');
            sessions[checkoutSessionId] = sessions[checkoutSessionId] || {};
            sessions[checkoutSessionId].user = { name: data.name, phone: data.phone, email: data.email };
            sessions[checkoutSessionId].location = data.loc;
            sessions[checkoutSessionId].shippingCost = shippingCost;
            sessions[checkoutSessionId].shippingMethod = shippingMethod;
            sessions[checkoutSessionId].updatedAt = Date.now();
            localStorage.setItem('checkout_sessions', JSON.stringify(sessions));
        }
    } catch(e) {}

    // 2. Save Order to DB - Passing orderRef as the 3rd argument
    try {
        await saveOrderToDb(data, 'WhatsApp', orderRef);
    } catch(e) {
        console.error('Failed to save order to DB:', e);
    }

    // 3. Build Comprehensive WhatsApp Message with Order Details
    const totalStr = document.getElementById('summaryTotal').innerText;
    const grandTotal = parseFloat(totalStr.replace(/[^\d.]/g, ''));
    
    // Build a natural, customer-style message without emojis
    const subtotal = cart.reduce((sum, item) => sum + (item.price * (item.qty || 1)), 0);
    let msg = `Hello,\n\n`;
    msg += `I would like to place the following order.\n\n`;
    msg += `Order number: ${orderRef}\n`;
    msg += `Name: ${data.name}\n`;
    msg += `Phone: ${data.phone}\n`;
    if (data.email) msg += `Email: ${data.email}\n`;
    msg += `\n`;

    msg += `Items:\n`;
    cart.forEach((item, idx) => {
        msg += `${idx + 1}) ${item.title}\n`;
        msg += `   Qty: ${item.qty || 1}\n`;
        msg += `   Price: Ksh ${item.price.toLocaleString()}\n\n`;
    });

    msg += `Order summary:\n`;
    msg += `Subtotal: Ksh ${subtotal.toLocaleString()}\n`;
    msg += `Shipping (${shippingMethod}): Ksh ${shippingCost}\n`;
    msg += `Total: Ksh ${grandTotal.toLocaleString()}\n\n`;

    msg += `Delivery method: ${shippingMethod}\n`;
    msg += `Delivery location: ${data.loc}\n\n`;

    msg += `Please confirm this order and let me know the payment instructions.\n\n`;
    msg += `Thank you.`;
    
    const encodedMsg = encodeURIComponent(msg);
    const phoneNumber = "254704843554"; 
    
    const appLink = `whatsapp://send?phone=${phoneNumber}&text=${encodedMsg}`;
    const webLink = `https://wa.me/${phoneNumber}?text=${encodedMsg}`;
    
    // Clear cart locally as the order is now successfully logged
    localStorage.removeItem('cart');

    // Track conversion with Google Ads
    gtag_report_conversion(webLink, grandTotal, orderRef);
}
// ================= ORDER SAVING LOGIC =================

// 1. Initialize Supabase (Ensure this matches your index.html config)
const sbUrl = 'https://ljxvxbjhkgoeygpyejkc.supabase.co'; 
const sbKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxqeHZ4Ympoa2dvZXlncHllamtjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1ODE3MzMsImV4cCI6MjA4MzE1NzczM30.fBrwtnv89UHgjs523rKCODE5W4nfBmDsP0AUQ8NgBlU';
const client = window.supabase.createClient(sbUrl, sbKey);

// Analytics Wrapper for Checkout
const sessionId = localStorage.getItem('site_session_id');

async function logCheckoutEvent(type) {
    if(!sessionId) return;
    await client.from('analytics').insert([{
        session_id: sessionId,
        event_type: type
    }]);
}


async function saveOrderToDb(data, method, orderRef) {
    // 1. Prepare Data
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const totalStr = document.getElementById('summaryTotal').innerText;
    const grandTotal = parseFloat(totalStr.replace(/[^\d.]/g, ''));
    const cleanPhone = String(data.phone).replace(/\s+/g, '');

    // 2. UPSERT CUSTOMER FIRST
    // This creates the customer or updates them if the phone exists
    const { data: customerData, error: custError } = await client
        .from('customers')
        .upsert({
            phone: cleanPhone,
            name: data.name,
            email: data.email,
            country: data.country,
            city: data.city,
            estate: data.estate,
            location: data.loc,
            last_order_at: new Date().toISOString()
        }, { onConflict: 'phone' })
        .select()
        .single();

    if (custError) {
        console.error("Customer Sync Error:", custError.message);
    }

    // 3. PREPARE ORDER PAYLOAD
    const orderPayload = {
        order_number: orderRef,
        customer_id: customerData ? customerData.id : null, // Links to customer table ID
        customer_name: data.name,
        customer_phone: cleanPhone,
        customer_email: data.email,
        customer_country: data.country,
        customer_city: data.city,
        customer_estate: data.estate,
        customer_location: data.loc, // Column from your schema
        delivery_location: data.loc, // Column from your schema
        items: cart,
        shipping_cost: shippingCost,
        shipping_method: shippingMethod, // Uses variable from your checkout logic
        total_amount: grandTotal,
        payment_method: method,
        status: 'pending'
    };

    // 4. SAVE TO ORDERS TABLE
    const { error: orderError } = await client.from('orders').insert([orderPayload]);
    
    if (orderError) {
        console.error("Order Save Failed:", orderError.message);
        throw orderError; // Stops the WhatsApp redirect if DB save fails
    }
}

// 1. REPLACING PROCESS PAYMENT
async function processPayment() {
    logCheckoutEvent('payment_click');
    const data = validateForm();
    if (!data) return;

    // Generate Order Reference
    const orderRef = "SHA-" + Math.floor(1000 + Math.random() * 9000);

    // Save to Database FIRST
    try {
        // Change 'Payment Gateway' to 'Bank/Paybill' for internal tracking
        await saveOrderToDb(data, 'Bank/Paybill', orderRef);
    } catch(e) {
        console.error('Failed to save order to DB:', e);
        alert("Error saving order. Check connection.");
        return;
    }

    // Display total and show modal
    const totalPayable = document.getElementById('summaryTotal').innerText;
    document.getElementById('modalTotalAmount').innerText = totalPayable;
    document.getElementById('paymentModal').classList.remove('hidden');
}

// 2. HELPER TO SWITCH BANK DETAILS
function switchMethod(method) {
    // Reset all tabs and details
    document.querySelectorAll('.payment-tab').forEach(btn => {
        btn.classList.remove('border-[#ea580c]', 'bg-orange-50');
        btn.classList.add('border-gray-100');
    });
    document.querySelectorAll('.method-detail').forEach(div => div.classList.add('hidden'));

    // Highlight selected tab
    const activeTab = document.getElementById('tab-' + method);
    activeTab.classList.remove('border-gray-100');
    activeTab.classList.add('border-[#ea580c]', 'bg-orange-50');

    // Show selected details
    document.getElementById('detail-' + method).classList.remove('hidden');
}

// 3. HANDLE FINAL CLICK
function handlePaid() {

    const total = document.getElementById('modalTotalAmount').innerText;
    const numericTotal = parseFloat(String(total).replace(/[^0-9.\-]+/g, '')) || 0;
    
    const businessPhone = "254704843554"; 
    
    // Get customer info from form
    const firstName = document.getElementById('custFirstName').value || '';
    const lastName = document.getElementById('custLastName').value || '';
    const custName = firstName && lastName ? `${firstName} ${lastName}` : 'Customer';
    const custPhone = document.getElementById('custPhone').value || 'N/A';
    const custEmail = document.getElementById('custEmail').value || '';
    const custCountry = document.getElementById('custCountry').value || 'N/A';
    const custCity = document.getElementById('custCity').value || 'N/A';
    const custEstate = document.getElementById('custEstate').value || 'N/A';
    const custLocation = document.getElementById('custLocation').value || 'N/A';
    
    // Build a natural payment confirmation message like a customer would send
    const subtotal = cart.reduce((sum, item) => sum + (item.price * (item.qty || 1)), 0);
    let message = `Hello,\n\n`;
    message += `I have just made a payment for my order.\n\n`;
    message += `Name: ${custName}\n`;
    message += `Phone: ${custPhone}\n`;
    if (custEmail) message += `Email: ${custEmail}\n`;
    message += `\n`;

    message += `Items:\n`;
    cart.forEach((item, idx) => {
        message += `${idx + 1}) ${item.title}\n`;
        message += `   Qty: ${item.qty || 1}\n`;
        message += `   Price: Ksh ${item.price.toLocaleString()}\n\n`;
    });

    message += `Payment details:\n`;
    message += `Subtotal: Ksh ${subtotal.toLocaleString()}\n`;
    message += `Shipping (${shippingMethod}): Ksh ${shippingCost}\n`;
    message += `Total paid: Ksh ${numericTotal.toLocaleString()}\n\n`;

    message += `Shipping Information:\n`;
    message += `Country: ${custCountry}\n`;
    message += `City: ${custCity}\n`;
    message += `Estate/Area: ${custEstate}\n`;
    message += `Delivery method: ${shippingMethod}\n`;
    message += `Delivery location: ${custLocation}\n\n`;

    message += `Please confirm receipt of payment and advise next steps.\n\n`;
    message += `Thank you.`;
    
    // Track Purchase event with Meta Pixel
    try {
        const content_ids = (cart || []).map(i => i.id);
        if (window.fbq) {
            fbq('track', 'Purchase', { value: numericTotal, currency: 'KES', content_ids: content_ids });
        }
    } catch (e) {
        console.warn('Purchase tracking failed', e);
    }

    const whatsappUrl = `https://wa.me/${businessPhone}?text=${encodeURIComponent(message)}`;
    alert("Opening WhatsApp to send your payment confirmation...");

    // Delay clearing cart and redirect to allow the pixel to send
    setTimeout(() => {
        localStorage.removeItem('cart');
        window.location.href = whatsappUrl;
    }, 350);
}

</script>
</body>
</html>