<!DOCTYPE html>
<html lang="en">

<head>
<script async src="https://www.googletagmanager.com/gtag/js?id=AW-17577238441"></script>
<script>
    window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'AW-17577238441');
</script>
<!-- Meta Pixel Code -->
<script>
!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '1815039102579831');
fbq('track', 'PageView');
</script>
<noscript><img height="1" width="1" style="display:none"
src="https://www.facebook.com/tr?id=1815039102579831&ev=PageView&noscript=1"
/></noscript>
<!-- End Meta Pixel Code -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="images/icon%20logo.png">
  <title>Shop - Sharkim Traders</title>
  
  <script src="https://cdn.tailwindcss.com/"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script src="js/cart.js"></script>
  
  <style>
    html, body { max-width: 100%; overflow-x: hidden; font-family: "Times New Roman", Times, serif, Arial, Helvetica, sans-serif; }
    img, svg { max-width: 100%; height: auto; }
    
    /* Brand Colors */
    .brand-orange { color: #ea580c; } /* Deep Orange */
    .bg-brand-orange { background-color: #ea580c; }
    .brand-green { background-color: #25D366; } /* WhatsApp Green */

    /* Header Background */
    .header-bg { background-color: #f3f4f6; }
    
    /* Announcement Bar Gradient */
    .announcement-bar {
        background: linear-gradient(90deg, #ac8334, #f59e0b, #ac8334);
        background-size: 200% 200%;
        animation: gradientMove 10s ease infinite;
    }

    /* AI Search Button Glow */
    .ai-search-glow {
      position: relative;
      z-index: 0;
      overflow: hidden;
      border-radius: 9999px; 
    }
    .ai-search-glow::before {
      content: '';
      position: absolute;
      z-index: -2;
      left: -50%; top: -50%; width: 200%; height: 200%;
      background-color: #399953;
      background-repeat: no-repeat;
      background-size: 50% 50%, 50% 50%;
      background-position: 0 0, 100% 0, 100% 100%, 0 100%;
      background-image: linear-gradient(#399953, #399953), linear-gradient(#fbb300, #fbb300), linear-gradient(#d53e33, #d53e33), linear-gradient(#377af5, #377af5);
      animation: rotate 4s linear infinite;
    }
    .ai-search-glow::after {
      content: '';
      position: absolute;
      z-index: -1;
      left: 3px; top: 3px; width: calc(100% - 6px); height: calc(100% - 6px);
      background: white;
      border-radius: 9999px;
    }

    /* Title Underline */
    .title-underline {
      position: relative;
      display: inline-block;
      padding-bottom: 8px;
    }
    .title-underline::after {
      content: '';
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: -8px;
      width: 120px;
      height: 6px;
      border-radius: 6px;
      background: linear-gradient(90deg, #ac8334, #f59e0b, #ac8334);
      background-size: 200% 100%;
      animation: gradientMove 3s linear infinite;
    }

    /* Horizontal Scroll Snap */
    .horizontal-scroll {
      display: flex;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      gap: 0.75rem; /* Reduced gap slightly for mobile compactness */
      padding-bottom: 1rem;
    }
    /* --- Row Styles: Mobile First --- */
    .independent-row { 
        display: flex !important; 
        overflow-x: auto !important; 
        gap: 0.75rem !important; 
        scroll-snap-type: x mandatory !important; 
        padding-bottom: 1rem !important; 
    }

    /* Mobile: Exactly 2 cards */
    .independent-row > * { 
        scroll-snap-align: start !important; 
        flex: 0 0 calc(50% - 0.5rem) !important; 
        min-width: calc(50% - 0.5rem) !important;
    }

    /* --- Desktop: Exactly 4 cards --- */
    @media (min-width: 768px) {
      .independent-row { 
          display: grid !important; 
          grid-template-columns: repeat(4, 1fr) !important; 
          overflow-x: visible !important; 
          gap: 1.5rem !important;
      }
      
      .independent-row > * { 
          flex: 0 0 auto !important; 
          width: 100% !important; 
          min-width: 0 !important;
      }
    
    }
    /* Custom Price Range Slider */
    .range-slider { position: relative; height: 5px; background: #ddd; border-radius: 5px; margin-top: 10px; margin-bottom: 20px; }
    .range-selected { height: 100%; left: 0%; right: 0%; position: absolute; border-radius: 5px; background: #ea580c; }
    .range-input { position: relative; }
    .range-input input {
      position: absolute; width: 100%; height: 5px; top: -7px; background: none; pointer-events: none;
      -webkit-appearance: none; -moz-appearance: none;
    }
    .range-input input::-webkit-slider-thumb {
      height: 18px; width: 18px; border-radius: 50%; border: 2px solid #ea580c; background: #fff;
      pointer-events: auto; -webkit-appearance: none; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }
    .range-input input::-moz-range-thumb {
      height: 18px; width: 18px; border: none; border-radius: 50%; background: #ea580c;
      pointer-events: auto; -moz-appearance: none; cursor: pointer;
    }

    /* Scrollbar for Filter Sidebar */
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* Pop Out Card Hover */
    .pop-out-card { transition: transform 0.3s ease, box-shadow 0.3s ease; }
    .pop-out-card:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
    
    .discount-badge { background: #ea580c !important; color: #ffffff !important; padding: 2px 6px !important; border-radius: 4px !important; }

    /* Price layout: keep actual price on its own line on small screens */
    .product-price-row { display:inline-flex; align-items:baseline; gap:0.25rem; flex-wrap:wrap; }
    .product-price-row .price-actual { font-weight:700; color: #ea580c; }
    @media (max-width:640px) {
      .product-price-row .price-actual { flex-basis:100%; }
    }

    /* Animations */
    @keyframes rotate { 100% { transform: rotate(1turn); } }
    @keyframes gradientMove { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
  </style>
</head>

<body class="bg-gray-100">

<div class="announcement-bar w-full text-white text-xs md:text-sm text-center py-2 px-4 font-bold tracking-wide">
  ðŸŽ‰ FREE Shipping on orders over Ksh 5000! | Limited Time Deals! ðŸšš
</div>

<header class="header-bg py-3 sticky top-0 z-40 shadow-sm">
  <div class="max-w-7xl mx-auto px-3 relative">
    <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <button id="mobileMenuBtn" class="md:hidden text-gray-800">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
          </button>
          <a href="index.html" class="flex-shrink-0 absolute left-1/2 transform -translate-x-1/2 md:static md:transform-none z-10">
            <img src="images/sharkim_gold_logo.png" alt="Sharkim Logo" class="h-16 md:h-24 object-contain" width="240" height="96">
          </a>
        </div>

        <div class="hidden md:flex flex-1 justify-center mx-12">
            <div class="relative w-full max-w-3xl flex items-center gap-4">
                <div class="relative flex-1">
                    <input type="text" id="searchInputDesktop" placeholder="I am looking for..." class="w-full pl-5 pr-32 py-3 rounded-full border border-gray-300 focus:outline-none focus:border-[#ea580c] bg-white shadow-sm">
                    <button id="searchBtnDesktop" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-[#ea580c]">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    </button>
                </div>
                <div class="flex-shrink-0">
                  <button id="aiSearchDesktop" class="ai-search-glow px-6 py-3 bg-white text-[#1f2937] font-semibold rounded-full shadow-sm">
                    Search with AI
                  </button>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-3">
        </div>
    </div>

    <div class="md:hidden mt-10 flex gap-2 w-full">
         <div class="relative flex-grow">
            <input type="text" id="searchInputMobile" placeholder="I am looking for..." class="w-full pl-3 pr-8 py-2.5 text-sm rounded-lg border border-gray-300 focus:outline-none focus:border-[#ea580c] bg-white">
            <button id="searchBtnMobile" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
            </button>
         </div>
         <button class="ai-search-glow px-3 py-2.5 text-xs font-bold text-gray-900 bg-white flex items-center gap-1 shadow-sm whitespace-nowrap" id="aiSearchMobile">
           Search with AI
         </button>
    </div>
  </div>
</header>

<div id="mobileMenuDrawer" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black bg-opacity-50" id="mobileMenuBackdrop"></div>
    <div class="absolute top-0 left-0 w-3/4 max-w-sm h-full bg-white shadow-xl flex flex-col transform transition-transform duration-300">
        <div class="p-4 flex justify-between items-center border-b">
            <h2 class="text-xl font-bold text-[#ea580c]">Categories</h2>
            <button id="closeMobileMenu" class="text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
        <ul id="mobileMenuListItems" class="p-4 space-y-2 overflow-y-auto flex-1"></ul>
    </div>
</div>

<main class="max-w-7xl mx-auto px-3 py-8 space-y-12">

    <div class="text-center">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-2"><span id="pageTitle" class="title-underline">Shop</span></h1>
        <p class="text-gray-500 mt-4" id="pageSubtitle">Browse our collection</p>
    </div>

    <section id="topPicksSection">
        <h2 class="text-2xl font-bold text-left mb-4 text-[#ea580c]">Top Picks</h2>
        <div class="space-y-4">
             <div class="independent-row" id="topPicksRow1"></div>
             <div class="independent-row" id="topPicksRow2"></div>
        </div>
    </section>

    <section id="subCatsSection">
        <h2 class="text-xl font-bold text-left mb-6 text-gray-800">Browse by Subcategory</h2>
        <div class="hidden md:grid md:grid-cols-6 gap-4" id="subCatsDesktopGrid"></div>
        
        <div class="md:hidden space-y-3">
             <div class="horizontal-scroll mobile-small-tiles" id="subCatsMobileRow1"></div>
             <div class="horizontal-scroll mobile-small-tiles" id="subCatsMobileRow2"></div>
             <div class="horizontal-scroll mobile-small-tiles" id="subCatsMobileRow3"></div>
        </div>
    </section>

    <section class="flex flex-col md:flex-row gap-8 items-start pt-6 border-t border-gray-200">
        
        <aside class="w-full md:w-1/4 bg-white p-5 rounded-xl shadow-sm border border-gray-100 md:sticky md:top-24">
            <div class="flex justify-between items-center mb-4">
                 <h3 class="font-bold text-lg text-gray-800" id="filterTitle">Filters</h3>
                 <button id="resetFilters" class="text-xs text-red-500 hover:underline">Reset</button>
            </div>
            
            <div class="mb-6">
                <h4 class="font-bold text-sm text-[#ea580c] mb-2 uppercase">Subcategories</h4>
                <div class="max-h-60 overflow-y-auto custom-scrollbar space-y-2 pr-2" id="filterSubcatList">
                    <p class="text-sm text-gray-400">Select a main category first.</p>
                </div>
            </div>

            <div class="mb-6">
                 <h4 class="font-bold text-sm text-[#ea580c] mb-1 uppercase">Price Range (Ksh)</h4>
                 <p class="text-xs text-gray-500 mb-3 italic">Slide to adjust</p>
                 
                 <div class="range-slider">
                     <div class="range-selected" id="sliderRange"></div>
                 </div>
                 <div class="range-input">
                     <input type="range" class="min-range" id="rangeMin" min="0" max="100000" value="0" step="100">
                     <input type="range" class="max-range" id="rangeMax" min="0" max="100000" value="100000" step="100">
                 </div>

                 <div class="flex items-center justify-between gap-2 mt-4">
                     <div class="w-1/2">
                         <label class="text-xs text-gray-500">Min</label>
                         <input type="number" id="inputMin" class="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:border-[#ea580c] outline-none">
                     </div>
                     <div class="w-1/2 text-right">
                         <label class="text-xs text-gray-500">Max</label>
                         <input type="number" id="inputMax" class="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:border-[#ea580c] outline-none text-right">
                     </div>
                 </div>
            </div>

            <button id="applyFiltersBtn" class="w-full bg-[#ea580c] text-white font-bold py-3 rounded-lg hover:bg-orange-700 transition shadow-md">
                APPLY FILTERS
            </button>
        </aside>

        <div class="w-full md:w-3/4">
            <div class="flex items-center justify-between mb-4">
                <span class="text-sm text-gray-500" id="resultCount">Showing all products</span>
                <select id="sortSelect" class="border border-gray-300 rounded p-1 text-sm bg-white">
                    <option value="newest">Newest First</option>
                    <option value="price_asc">Price: Low to High</option>
                    <option value="price_desc">Price: High to Low</option>
                </select>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="mainProductGrid">
                <div class="col-span-full text-center py-20">
                    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-[#ea580c] mx-auto"></div>
                </div>
            </div>
        </div>

    </section>

</main>

<footer class="bg-black text-gray-300 mt-10">
  <div class="max-w-7xl mx-auto px-6 py-10 grid grid-cols-1 md:grid-cols-3 gap-8 items-start">
    <div class="order-1">
      <img src="images/sharkim_gold_logo.png" alt="Company Logo" class="h-24 mb-4 object-contain" width="200" height="80">
      <p class="mb-2">WhatsApp Us: <a href="https://wa.me/254704843554" class="text-[#ac8334] font-medium">+254 704 843 554</a></p>
      <p class="mb-2">Call Us: <a href="tel:+254704843554" class="text-white font-medium">+254 704 843 554</a></p>
      <p class="mb-2">Email Us: <a href="mailto:sharkimtraders97@gmail.com" class="text-[#ac8334] font-medium">sharkimtraders97@gmail.com</a></p>
      <p class="text-sm text-gray-400">Time: 8:30AM - 6:30PM</p>
    </div>

    <div class="order-2 flex justify-center md:justify-center">
      <div class="w-full md:w-64">
        <h3 class="text-lg font-semibold mb-3 text-white text-left md:text-left">Quick Links</h3>
        <ul class="space-y-2 text-gray-400 text-sm">
  <li>
      <a href="policies.html?id=shipping" class="hover:text-[#ac8334] transition-colors">Shipping Policy</a>
  </li>
  <li>
      <a href="policies.html?id=return" class="hover:text-[#ac8334] transition-colors">Return Policy</a>
  </li>
  <li>
      <a href="policies.html?id=terms" class="hover:text-[#ac8334] transition-colors">Terms & Conditions</a>
  </li>
</ul>
      </div>
    </div>

    <div class="order-3 text-right md:text-right">
      <h3 class="text-lg font-semibold mb-3 text-white">Working Hours</h3>
      <p class="mb-1">Monday - Saturday: <span class="font-medium">08:30 - 18:30</span></p>
      <p class="mb-3">Sunday: <span class="text-red-500">Closed</span></p>

      <h3 class="text-lg font-semibold mb-3 text-white">Payments</h3>
      <div class="flex space-x-3 bg-white p-2 rounded justify-end"> <img src="images/mpesa1.png" alt="MPESA" class="h-8 object-contain">
        <img src="images/im-bank.png" alt="I&M Bank" class="h-8 object-contain">
        <img src="images/equity.png" alt="Equity Bank" class="h-8 object-contain">
      </div>
    </div>
  </div>
  <div class="bg-black text-[#ac8334] text-center py-3 mt-6 border-t border-gray-800">
    <p class="text-sm">&copy; 2025 Sharkim Traders. All rights reserved.</p>
  </div>
</footer>

<script src="js/categories.js"></script>
<script>
// =====================
// SUPABASE CONFIG
// =====================
const SUPABASE_URL = 'https://ljxvxbjhkgoeygpyejkc.supabase.co/';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxqeHZ4Ympoa2dvZXlncHllamtjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1ODE3MzMsImV4cCI6MjA4MzE1NzczM30.fBrwtnv89UHgjs523rKCODE5W4nfBmDsP0AUQ8NgBlU';
const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
let searchHistory = [];
let currentSessionId = localStorage.getItem('site_session_id');

// ================= ANALYTICS TRACKING SYSTEM =================

// 1. Initialize or Update Session
async function initSession() {
    const now = new Date();
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) ? 'Mobile' : 'Desktop';

    try {
        if (!currentSessionId) {
            const { data, error } = await client.from('site_sessions')
                .insert([{ device_type: isMobile }])
                .select()
                .single();

            if (error) {
                console.warn('initSession: supabase insert failed', error);
                // If server rejects (401/unauthorized) fall back to a local session id
                currentSessionId = 'local-' + Date.now();
                localStorage.setItem('site_session_id', currentSessionId);
                return;
            }

            if (data) {
                currentSessionId = data.session_id;
                localStorage.setItem('site_session_id', currentSessionId);
            }
        } else {
            const { error } = await client.from('site_sessions')
                .update({ last_active_at: now })
                .eq('session_id', currentSessionId);
            if (error) console.warn('initSession update failed', error);
        }
    } catch (e) {
        console.warn('initSession unexpected error', e);
        // fallback to local session id so analytics calls don't block
        if (!currentSessionId) {
            currentSessionId = 'local-' + Date.now();
            localStorage.setItem('site_session_id', currentSessionId);
        }
    }
}

// When an image fails to load on the public site, try fetching the authoritative
// image URL from Supabase (products table) and update the DOM + local cache.
async function repairProductImage(productId, imgEl){
    try {
        if (!productId || !imgEl) return;
        if (imgEl.__repair_attempt) return; // avoid loops
        imgEl.__repair_attempt = true;

        const { data, error } = await client.from('products').select('id, image_url, images').eq('id', productId).limit(1).single();
        if (error || !data) {
            console.warn('repairProductImage: failed to fetch product', productId, error);
            imgEl.src = 'images/sharkim_gold_logo.png';
            return;
        }

        const newUrl = (data.images && data.images.length) ? data.images[0] : data.image_url;
        if (!newUrl) { imgEl.src = 'images/sharkim_gold_logo.png'; return; }

        // only attempt network sources
        const low = (''+newUrl).toLowerCase();
        if (low.startsWith('blob:') || low.startsWith('data:') || low.startsWith('file:')) {
            imgEl.src = 'images/sharkim_gold_logo.png';
            return;
        }

        // Update DOM
        imgEl.src = newUrl;

        // Update productMetadata cache if present
        try {
            const cached = localStorage.getItem('productMetadata');
            if (cached) {
                const arr = JSON.parse(cached || '[]');
                let changed = false;
                for (let i=0;i<arr.length;i++){
                    if (String(arr[i].id) === String(productId)){
                        arr[i].image_url = newUrl;
                        changed = true; break;
                    }
                }
                if (changed) localStorage.setItem('productMetadata', JSON.stringify(arr));
            }
        } catch(e){}
    } catch(e) {
        console.warn('repairProductImage unexpected', e);
        try{ imgEl.src = 'images/sharkim_gold_logo.png'; }catch(e){}
    }
}

function handleMissingImage(img, productId){
    try{
        if (!img || img.__missing_handled) return;
        img.__missing_handled = true;
        // immediate placeholder while we repair
        img.src = 'images/sharkim_gold_logo.png';
        // attempt asynchronous repair
        setTimeout(()=> repairProductImage(productId, img), 50);
    }catch(e){}
}

// 2. Generic Event Logger
async function logEvent(type, metadata = {}, productId = null) {
    if (!currentSessionId) await initSession();
    
    await client.from('analytics').insert([{
        session_id: currentSessionId,
        event_type: type,
        product_id: productId,
        metadata: metadata
    }]);
}

// GLOBAL VARIABLES

let allProducts = [];
let categoryProducts = [];
let currentMainCategory = '';
let currentSubCategory = '';
let minPriceLimit = 0;
let maxPriceLimit = 100000;

// NEW: Loading State Variables
let currentLoadedCount = 0;
let loadLimit = 50;
let scrollObserver = null;

// TRENDING PRODUCTS FUNCTION
async function fetchTrendingProducts() {
    // Fetch all view events
    const { data: views, error } = await client.from('analytics').select('product_id').eq('event_type', 'view_product');

    if (error) {
        console.error("Error fetching views:", error);
        // Fallback to random products
        return getRandomProducts(7);
    }

    // Count views per product
    const viewCount = {};
    views.forEach(v => {
        const pid = v.product_id;
        viewCount[pid] = (viewCount[pid] || 0) + 1;
    });

    // Sort product ids by view count descending
    const sortedIds = Object.keys(viewCount).sort((a, b) => viewCount[b] - viewCount[a]);

    // Take top 7
    const topIds = sortedIds.slice(0, 7);

    // Fetch product details
    const { data: products } = await client.from('products').select('*').in('id', topIds);

    // Sort by view count
    const trending = (products || []).sort((a, b) => viewCount[b.id] - viewCount[a.id]);

    // If less than 7, fill with random products
    if (trending.length < 7) {
        const remaining = 7 - trending.length;
        const randoms = getRandomProducts(remaining, trending.map(p => p.id));
        trending.push(...randoms);
    }

    return trending;
}

function getRandomProducts(count, excludeIds = []) {
    const available = allProducts.filter(p => !excludeIds.includes(p.id));
    const shuffled = available.sort(() => 0.5 - Math.random());
    return shuffled.slice(0, count);
}

// INITIALIZATION
// =====================
async function init() {
    const urlParams = new URLSearchParams(window.location.search);
    currentMainCategory = urlParams.get('main') || '';
    const searchQ = urlParams.get('q');

    // Check for cached metadata first
    const cached = localStorage.getItem('productMetadata');
    if (cached) {
        const parsed = JSON.parse(cached);
        if (parsed.length > 0 && parsed[0].hasOwnProperty('subcategory')) {
            // Cache has subcategory, use it
            allProducts = parsed.map(p => ({
                ...p,
                main_category: p.main_category || 'Uncategorized',
                subcategory: p.subcategory || ''
            }));
        } else {
            // Old cache without subcategory, fetch fresh and update cache
            const { data, error } = await client.from('products').select('*');
            if (error) { console.error("Error fetching:", error); return; }

            allProducts = (data || []).map(p => ({
                ...p,
                main_category: p.main_category || p.category || 'Uncategorized',
                subcategory: p.sub_category || p.subcategory || ''
            }));

            // Update cache with subcategory
            const metadata = allProducts.map(p => ({
                id: p.id,
                title: p.title,
                price: p.price,
                image_url: p.image_url,
                main_category: p.main_category,
                original_price: p.original_price,
                subcategory: p.subcategory
            })).sort((a, b) => a.id - b.id);
            localStorage.setItem('productMetadata', JSON.stringify(metadata));
        }
    } else {
        // No cache, fetch all
        const { data, error } = await client.from('products').select('*');
        if (error) { console.error("Error fetching:", error); return; }

        allProducts = (data || []).map(p => ({
            ...p,
            main_category: p.main_category || p.category || 'Uncategorized',
            subcategory: p.sub_category || p.subcategory || ''
        }));

        // Cache metadata for future use
        const metadata = allProducts.map(p => ({
            id: p.id,
            title: p.title,
            price: p.price,
            image_url: p.image_url,
            main_category: p.main_category,
            original_price: p.original_price,
            subcategory: p.subcategory
        })).sort((a, b) => a.id - b.id);
        localStorage.setItem('productMetadata', JSON.stringify(metadata));
    }

    if(searchQ) {
        document.getElementById('pageTitle').innerText = `Search: "${searchQ}"`;
        document.getElementById('pageSubtitle').innerText = "Results matching your search";
        categoryProducts = allProducts.filter(p => p.title.toLowerCase().includes(searchQ.toLowerCase()));
        document.getElementById('subCatsSection').style.display = 'none';
        document.getElementById('topPicksSection').style.display = 'none';
        document.getElementById('pageTitle').innerText = `Search: "${searchQ}"`;
        document.getElementById('pageSubtitle').innerText = "Results matching your search";
        categoryProducts = allProducts.filter(p => p.title.toLowerCase().includes(searchQ.toLowerCase()));
        document.getElementById('subCatsSection').style.display = 'none';
        document.getElementById('topPicksSection').style.display = 'none';
        document.getElementById('filterTitle').innerText = "Refine Search";
    }
    else if (currentMainCategory) {
        document.getElementById('pageTitle').innerText = currentMainCategory;
        document.getElementById('filterTitle').innerText = currentMainCategory;
        categoryProducts = allProducts.filter(p => p.main_category === currentMainCategory);
    } else {
        document.getElementById('pageTitle').innerText = "All Products";
        document.getElementById('filterTitle').innerText = "All Categories";
        categoryProducts = allProducts;
        document.getElementById('subCatsSection').style.display = 'none';
    }

    setupPriceRangeLimits();
    renderTopPicks();
    if(currentMainCategory && !searchQ) renderSubCategoryCards();
    renderFilterSidebar();
    applyFilters();
}

// =====================
// TOP PICKS
// =====================
function renderTopPicks() {
    const row1 = document.getElementById('topPicksRow1');
    const row2 = document.getElementById('topPicksRow2');
    row1.innerHTML = ''; row2.innerHTML = '';

    const picks = categoryProducts.slice(0, 8);

    if(picks.length === 0) {
        document.getElementById('topPicksSection').style.display = 'none';
        return;
    }

    picks.forEach((p, i) => {
        const card = renderProductCard(p);
        if (i % 2 === 0) row1.appendChild(card);
        else row2.appendChild(card);
    });
}

// If a subcategory image loads but is too small on mobile, replace it with the main logo
function checkImageSize(img) {
  try {
    if (img.__sh_check_done) return;
    // mark to avoid repeated replacement loops
    img.__sh_check_done = true;
    if (window.innerWidth < 768) {
      var nw = img.naturalWidth || 0;
      var nh = img.naturalHeight || 0;
      if (nw > 0 && nh > 0) {
        // if the actual image is very small, use site logo instead
        if (Math.max(nw, nh) < 120) {
          img.src = 'images/sharkim_gold_logo.png';
        }
      } else {
        // if not loaded yet, retry shortly
        setTimeout(function(){
          try { if(!img.__sh_check_done) checkImageSize(img); }
          catch(e){}
        }, 200);
      }
    }
  } catch(e) {}
}

// =====================
// SUBCATEGORY CARDS
// =====================
function renderSubCategoryCards() {
    const subcats = window.getSubcategories(currentMainCategory) || [];
    const desktopGrid = document.getElementById('subCatsDesktopGrid');
    const mRow1 = document.getElementById('subCatsMobileRow1');
    const mRow2 = document.getElementById('subCatsMobileRow2');
    const mRow3 = document.getElementById('subCatsMobileRow3');

    if(subcats.length === 0) {
        document.getElementById('subCatsSection').style.display = 'none';
        return;
    }

    subcats.forEach((sub, index) => {
      const repProduct = categoryProducts.find(p => p.subcategory === sub);
      const imgUrl = (repProduct && repProduct.image_url) ? repProduct.image_url : 'images/sharkim_gold_logo.png';
        
        // Common Card Logic: Image above, text below. 
        // We use classes like 'h-16' for mobile tiles to keep them small.
        const card = document.createElement('div');
        // Mobile style base (small tiles) -> Desktop style (larger) via md classes
        card.className = "flex flex-col items-center cursor-pointer group";

        card.innerHTML = `
              <div class="w-full h-16 md:h-32 rounded-lg overflow-hidden border border-gray-200 shadow-sm relative bg-white">
                <img src="${imgUrl}" onerror="this.onerror=null;this.src='images/sharkim_gold_logo.png';" onload="checkImageSize(this)" class="w-full h-full object-cover group-hover:scale-105 transition duration-300" loading="lazy" alt="${sub}">
              </div>
            <span class="mt-1 md:mt-2 text-[10px] md:text-sm font-bold text-gray-700 text-center leading-tight group-hover:text-[#ea580c] px-1">${sub}</span>
        `;
        
        card.onclick = () => { selectSubCategory(sub); };

        // Desktop
        const desktopCard = card.cloneNode(true);
        desktopCard.onclick = () => { selectSubCategory(sub); };
        desktopGrid.appendChild(desktopCard);

        // Mobile
        const mobileCard = card.cloneNode(true);
        mobileCard.onclick = () => { selectSubCategory(sub); }; // Re-attach listener
        
        if (index % 3 === 0) mRow1.appendChild(mobileCard);
        else if (index % 3 === 1) mRow2.appendChild(mobileCard);
        else mRow3.appendChild(mobileCard);
    });
}

// SIDEBAR FILTERS

function setupPriceRangeLimits() {
    if(categoryProducts.length === 0) return;
    const prices = categoryProducts.map(p => Number(p.price) || 0);
    minPriceLimit = Math.min(...prices);
    maxPriceLimit = Math.max(...prices);

    const rangeMin = document.getElementById('rangeMin');
    const rangeMax = document.getElementById('rangeMax');
    const inputMin = document.getElementById('inputMin');
    const inputMax = document.getElementById('inputMax');

    rangeMin.min = minPriceLimit; rangeMin.max = maxPriceLimit; rangeMin.value = minPriceLimit;
    rangeMax.min = minPriceLimit; rangeMax.max = maxPriceLimit; rangeMax.value = maxPriceLimit;
    inputMin.value = minPriceLimit;
    inputMax.value = maxPriceLimit;

    updateSliderTrack();
}

function renderFilterSidebar() {
    const list = document.getElementById('filterSubcatList');
    list.innerHTML = '';
    
    const subcats = window.getSubcategories(currentMainCategory) || [];
    
    const allOpt = document.createElement('div');
    allOpt.className = "flex items-center gap-2 cursor-pointer p-1 hover:bg-gray-50 rounded";
    allOpt.innerHTML = `<input type="radio" name="subcatFilter" value="" checked class="accent-[#ea580c]"> <span class="text-sm text-gray-700">All Subcategories</span>`;
    allOpt.onclick = () => { selectSubCategory(''); document.querySelector('input[value=""]').checked = true; };
    list.appendChild(allOpt);

    subcats.forEach(sub => {
        const div = document.createElement('div');
        div.className = "flex items-center gap-2 cursor-pointer p-1 hover:bg-gray-50 rounded";
        div.innerHTML = `<input type="radio" name="subcatFilter" value="${sub}" class="accent-[#ea580c]"> <span class="text-sm text-gray-700">${sub}</span>`;
        div.onclick = () => { 
            div.querySelector('input').checked = true;
            selectSubCategory(sub); 
        };
        list.appendChild(div);
    });
}

function selectSubCategory(sub) {
    currentSubCategory = sub;
    const radios = document.getElementsByName('subcatFilter');
    radios.forEach(r => { if(r.value === sub) r.checked = true; });
    applyFilters();
    if(window.innerWidth < 768) document.getElementById('mainProductGrid').scrollIntoView({behavior: 'smooth'});
}

function applyFilters() {
    const minP = Number(document.getElementById('inputMin').value);
    const maxP = Number(document.getElementById('inputMax').value);
    const sortVal = document.getElementById('sortSelect').value;

    let filtered = categoryProducts.filter(p => {
        if(currentSubCategory && p.subcategory !== currentSubCategory) return false;
        const price = Number(p.price) || 0;
        if(price < minP || price > maxP) return false;
        return true;
    });

    if(sortVal === 'price_asc') filtered.sort((a,b) => (Number(a.price) - Number(b.price)));
    else if(sortVal === 'price_desc') filtered.sort((a,b) => (Number(b.price) - Number(a.price)));
    else if(sortVal === 'newest') filtered.sort((a,b) => b.id - a.id);

    renderMainGrid(filtered);
}

function renderBatch(products, start, batchSize, container, insertBefore = null) {
    const end = Math.min(start + batchSize, products.length);
    for (let i = start; i < end; i++) {
        const card = renderProductCard(products[i]);
        if (insertBefore) {
            container.insertBefore(card, insertBefore);
        } else {
            container.appendChild(card);
        }
    }
    return end - start; // return how many added
}

function renderMainGrid(products) {
    // products is already filtered
    const grid = document.getElementById('mainProductGrid');
    const countEl = document.getElementById('resultCount');
    grid.innerHTML = '';

    const totalProducts = products.length;

    if(totalProducts === 0) {
        grid.innerHTML = `<div class="col-span-full text-center py-10 text-gray-500">No products found matching your filters.</div>`;
        countEl.innerText = `Showing 0 products`;
        return;
    }

    const isSub = currentSubCategory !== '';
    // If subcategory selected, show all filtered products in grid, else slice after top picks
    const gridProducts = isSub ? products : products.slice(8);
    let currentLoaded = 0;
    let showMoreButton = gridProducts.length > 50;

    // Always show 50 initially, with show more if more
    currentLoaded = Math.min(50, gridProducts.length);

    // Render in batches to prevent UI freeze
    renderBatch(gridProducts, 0, currentLoaded, grid);

    const wholeTotal = categoryProducts.length;
    const shown = isSub ? totalProducts : Math.min(wholeTotal, 8 + currentLoaded);
    const countText = isSub ? `Showing ${shown} out of ${wholeTotal} products` : `Showing ${shown} of ${wholeTotal} products`;
    countEl.innerText = countText;

    if (showMoreButton) {
        const buttonDiv = document.createElement('div');
        buttonDiv.className = 'col-span-full text-center py-8';
        buttonDiv.innerHTML = `
            <button id="showMoreBtn" class="bg-[#ea580c] text-white font-bold py-3 px-6 rounded-lg hover:bg-orange-700 transition shadow-md">
                Show More
            </button>
        `;
        grid.appendChild(buttonDiv);

        const loadMore = () => {
            const nextBatchSize = 50;
            const added = renderBatch(gridProducts, currentLoaded, nextBatchSize, grid, buttonDiv);
            currentLoaded += added;
            const newShown = isSub ? totalProducts : Math.min(wholeTotal, 8 + currentLoaded);
            const newCountText = isSub ? `Showing ${newShown} out of ${wholeTotal} products` : `Showing ${newShown} of ${wholeTotal} products`;
            countEl.innerText = newCountText;
            if (currentLoaded >= gridProducts.length) {
                buttonDiv.remove();
            }
        };

        document.getElementById('showMoreBtn').addEventListener('click', loadMore);
    }
}

// =====================
// CARD RENDERER
// =====================
function renderProductCard(product) {
  const disc = (product.original_price && product.original_price > product.price)
    ? Math.round(((product.original_price - product.price)/product.original_price)*100) : 0;

  const el = document.createElement('div');
  // Removed fixed widths here, controlled by parent container (grid or horizontal-scroll)
  el.className = `bg-white p-4 rounded-xl shadow-sm border border-gray-100 relative pop-out-card h-80`;

  el.innerHTML = `
    <a href="product.html?id=${encodeURIComponent(product.id)}" class="block flex flex-col h-full">
      <div class="block mb-3 relative aspect-[4/5] overflow-hidden rounded-lg flex items-center justify-center p-2 bg-white">
        <img src="${product.image_url}" data-product-id="${product.id}" onerror="handleMissingImage(this, '${product.id}')" class="w-full h-full object-contain hover:scale-105 transition duration-300" loading="lazy" alt="${product.title}">
        ${disc ? `<span class="discount-badge absolute top-0 left-0 text-[10px] font-bold">-${disc}%</span>` : ''}
      </div>

      <div class="flex-1 flex flex-col">
        <h3 class="text-sm font-bold text-gray-800 line-clamp-1 leading-tight mb-1 overflow-hidden text-ellipsis whitespace-nowrap">${product.title}</h3>
        <div class="mb-2 product-price-row">
          ${product.original_price ? `<span class="text-xs text-gray-400 line-through mr-1">Ksh ${product.original_price}</span>` : ''}
          <span class="text-base price-actual">Ksh ${product.price}</span>
        </div>

        <div class="mt-auto flex flex-col gap-2">
          <button onclick="event.stopPropagation(); addToCart('${product.id}')" class="w-full py-1.5 border border-gray-200 bg-white text-gray-800 text-xs font-bold rounded hover:bg-gray-50 hover:text-[#ea580c] transition">
            ADD TO CART
          </button>

          <button onclick="event.stopPropagation(); buyNowSilent('${product.id}')" class="w-full py-1.5 bg-[#ea580c] text-white text-xs font-bold rounded text-center hover:bg-orange-700 transition">
            BUY NOW
          </button>
        </div>
      </div>
    </a>
  `;
  return el;
}



// =====================
// PRICE SLIDER UX
// =====================
const rangeMin = document.getElementById('rangeMin');
const rangeMax = document.getElementById('rangeMax');
const inputMin = document.getElementById('inputMin');
const inputMax = document.getElementById('inputMax');
const sliderRange = document.getElementById('sliderRange');
const priceGap = 100;

function updateSliderTrack() {
    const min = parseInt(rangeMin.value), max = parseInt(rangeMax.value);
    const percent1 = ((min - rangeMin.min) / (rangeMin.max - rangeMin.min)) * 100;
    const percent2 = ((max - rangeMax.min) / (rangeMax.max - rangeMax.min)) * 100;
    sliderRange.style.left = percent1 + "%";
    sliderRange.style.right = (100 - percent2) + "%";
}

[rangeMin, rangeMax].forEach(input => {
    input.addEventListener('input', (e) => {
        let minVal = parseInt(rangeMin.value), maxVal = parseInt(rangeMax.value);
        if((maxVal - minVal) < priceGap) {
            if(e.target.className === "min-range") rangeMin.value = maxVal - priceGap;
            else rangeMax.value = minVal + priceGap;
        } else {
            inputMin.value = minVal; inputMax.value = maxVal;
            updateSliderTrack();
        }
    });
});

[inputMin, inputMax].forEach(input => {
    input.addEventListener('change', (e) => {
        let minVal = parseInt(inputMin.value), maxVal = parseInt(inputMax.value);
        if((maxVal - minVal >= priceGap) && maxVal <= parseInt(rangeMax.max) && minVal >= parseInt(rangeMin.min)) {
            rangeMin.value = minVal; rangeMax.value = maxVal;
            updateSliderTrack();
        }
    });
});

// =====================
// EVENTS
// =====================
document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
document.getElementById('resetFilters').addEventListener('click', () => {
    currentSubCategory = '';
    setupPriceRangeLimits(); 
    const radios = document.getElementsByName('subcatFilter');
    if(radios.length) radios[0].checked = true;
    applyFilters();
});
document.getElementById('sortSelect').addEventListener('change', applyFilters);

// Mobile Menu
const mobileMenuBtn = document.getElementById('mobileMenuBtn');
const mobileMenuDrawer = document.getElementById('mobileMenuDrawer');
const mobileMenuBackdrop = document.getElementById('mobileMenuBackdrop');
const closeMobileMenu = document.getElementById('closeMobileMenu');
const mobileMenuListItems = document.getElementById('mobileMenuListItems');

function toggleMobileMenu() { mobileMenuDrawer.classList.toggle('hidden'); }
if(mobileMenuBtn) mobileMenuBtn.addEventListener('click', toggleMobileMenu);
if(closeMobileMenu) closeMobileMenu.addEventListener('click', toggleMobileMenu);
if(mobileMenuBackdrop) mobileMenuBackdrop.addEventListener('click', toggleMobileMenu);

function buildMobileMenu(){
  mobileMenuListItems.innerHTML = '';
  (window.MAIN_CATEGORIES || []).forEach(cat => {
    const li = document.createElement('li');
    li.innerHTML = `<a class="block px-4 py-3 rounded-lg text-gray-700 font-medium hover:bg-gray-100 hover:text-[#ea580c] transition" href="shop.html?main=${encodeURIComponent(cat)}">${cat}</a>`;
    mobileMenuListItems.appendChild(li);
  });
}
setTimeout(buildMobileMenu, 500);

function handleSearch(id) {
    const val = document.getElementById(id).value.trim();
    if (val) {
        try { if (window.fbq) fbq('track', 'Search', { search_string: val }); } catch (e) { console.warn('Search tracking failed', e); }
        window.location.href = `shop.html?q=${encodeURIComponent(val)}`;
    }
}
document.getElementById('searchBtnDesktop').addEventListener('click', () => handleSearch('searchInputDesktop'));
document.getElementById('searchBtnMobile').addEventListener('click', () => handleSearch('searchInputMobile'));

// =====================
// NEW: AI Search Logic
// =====================

// 1. Safe Helper to ensure UI exists before use
// 1. Safe Helper - Made more aggressive
function ensureAiUiExists() {
    let modal = document.getElementById('ai-search-modal');
    if (!modal) {
        console.time("UI_Injection_Speed"); // Start timer
        injectAiUi();
        modal = document.getElementById('ai-search-modal');
        console.timeEnd("UI_Injection_Speed"); // See how long injection took
    }
    return modal;
}

// 2. Move the call OUTSIDE of any event listeners

injectAiUi(); 

// 2. The Trigger Function
async function handleAiSearch(query) {
    if (!query) return;

    // Track Search Event for Meta Pixel
    fbq('track', 'Search', {search_string: query});

    // Ensure UI is ready (Modal/Container)
    const modal = ensureAiUiExists();
    const chatContainer = document.getElementById('ai-chat-container');

    if (!modal || !chatContainer) {
        console.error("AI Search UI could not be initialized.");
        return;
    }

    // Show the modal and add the user's message
    modal.classList.remove('hidden');
    addChatMessage('user', query);
    const loadingId = addLoadingIndicator();

    try {
        // CALL THE EDGE FUNCTION
        // 'client' must be your initialized supabase object
        const { data, error } = await client.functions.invoke('ai-search', {
            body: { 
                query: query, 
                history: searchHistory 
            }
        });

        // If Supabase returns a specific error
        if (error) throw error;

        removeLoadingIndicator(loadingId);

        if (data) {
            // Display response (Uses your existing UI logic)
            addAiResponse(data.pre_text || "Here is what I found:", data.refined_products || []);
            
            // Save to history for the next turn
            searchHistory.push({ role: 'user', content: query });
            searchHistory.push({ 
                role: 'assistant', 
                content: data.pre_text, 
                product_ids: (data.refined_products || []).map(p => p.id) 
            });
        }
    } catch (err) {
        removeLoadingIndicator(loadingId);
        console.error("Edge Function Error:", err);
        
        // Friendly UI error message
        const container = document.getElementById('ai-chat-container');
        if (container) {
            addChatMessage('ai', "I'm having trouble connecting to the network. Please check your connection and try again.");
        }
    }
}
// 3. Updated Event Listeners
const searchConfig = [
    { btn: 'searchBtnDesktop', input: 'searchInputDesktop' },
    { btn: 'searchBtnMobile', input: 'searchInputMobile' },
    { btn: 'aiSearchDesktop', input: 'searchInputDesktop' },
    { btn: 'aiSearchMobile', input: 'searchInputMobile' }
];

searchConfig.forEach(({ btn, input }) => {
    const btnEl = document.getElementById(btn);
    const inputEl = document.getElementById(input);
    
    if (btnEl) {
        // Clone to clear old keyword-search listeners
        const newBtn = btnEl.cloneNode(true);
        btnEl.parentNode.replaceChild(newBtn, btnEl);

        newBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const val = inputEl ? inputEl.value.trim() : '';
            
            const modal = ensureAiUiExists();

            if (val) {
                handleAiSearch(val);
                if(inputEl) inputEl.value = ''; 
            } else if (modal) {
                // If empty, just open the AI chat modal
                modal.classList.remove('hidden');
            }
        });
    }
});
// =====================
// UI HELPER FUNCTIONS
// =====================

// Generates HTML for a Single Product Card
function createProductCard(p, isHorizontal = false) {
    const card = document.createElement('div');
    
    // Different styles for Homepage Grid vs AI Horizontal Scroll
    const wrapperClass = isHorizontal 
        ? "min-w-[260px] w-[260px] snap-center bg-white border rounded-lg shadow-sm flex-shrink-0 mr-4"
        : "bg-white border rounded-lg shadow-sm hover:shadow-md transition relative";
    
    card.className = wrapperClass;
    
    // Logic for Image: specific to your new DB schema (image_url)
    // Also handles the "In Stock" badge
    const stockBadge = (p.stock_quantity && p.stock_quantity > 0) 
        ? '<span class="absolute top-2 right-2 bg-green-100 text-green-800 text-xs px-2 py-1 rounded z-10">In Stock</span>' 
        : '';

    card.innerHTML = `
      <a href="product.html?id=${p.id}" class="block h-full flex flex-col">
        <div class="h-48 p-4 flex items-center justify-center relative">
           ${stockBadge}
           <img src="${p.image_url || 'placeholder.jpg'}" data-product-id="${p.id}" onerror="handleMissingImage(this, '${p.id}')" class="h-full object-contain mx-auto" loading="lazy" alt="${p.title}">
        </div>
        <div class="p-4 border-t flex-1 flex flex-col justify-between">
          <div>
            <h3 class="text-sm font-bold text-gray-800 line-clamp-2 mb-2">${p.title}</h3>
            <div class="text-xs text-gray-500 line-through">${p.original_price ? 'Ksh ' + p.original_price : ''}</div>
            <div class="text-[#ea580c] font-bold text-lg">Ksh ${p.price}</div>
          </div>
        </div>
      </a>
    `;
    return card;
}

// Injects the Hidden AI Modal into HTML
function injectAiUi() {
    if (document.getElementById('ai-search-modal')) return; // Don't create twice

    const div = document.createElement('div');
    div.id = 'ai-search-modal';
    div.className = 'fixed inset-0 bg-black/60 z-[9999] hidden flex flex-col justify-end sm:justify-center items-center backdrop-blur-sm transition-all';
    div.innerHTML = `
      <div class="bg-gray-50 w-full max-w-2xl h-[85vh] sm:h-[80vh] sm:rounded-xl shadow-2xl flex flex-col overflow-hidden animate-slide-up">
        <div class="p-4 bg-white border-b flex justify-between items-center shadow-sm">
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                <h2 class="font-bold text-gray-800">AI Assistant</h2>
            </div>
            <button onclick="document.getElementById('ai-search-modal').classList.add('hidden')" class="p-2 hover:bg-gray-100 rounded-full transition">
                <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <div id="ai-chat-container" class="flex-1 overflow-y-auto p-4 space-y-6 scroll-smooth">
            <div class="text-center text-gray-400 text-sm mt-10">
                <p class="mb-2">Try searching for:</p>
                <span class="inline-block bg-white px-3 py-1 rounded-full border text-xs m-1">"Cheap phones 128gb"</span>
                <span class="inline-block bg-white px-3 py-1 rounded-full border text-xs m-1">"Laptops for gaming"</span>
            </div>
        </div>

        <div class="p-3 bg-white border-t">
            <div class="flex gap-2 relative">
                <input id="ai-refine-input" type="text" placeholder="Refine results... (e.g. 'Under 40k')" 
                    class="w-full pl-4 pr-12 py-3 border rounded-full focus:outline-none focus:ring-2 focus:ring-black text-sm shadow-sm"
                    onkeypress="if(event.key === 'Enter') document.getElementById('ai-send-btn').click()">
                <button id="ai-send-btn" class="absolute right-2 top-1.5 bg-black text-white p-2 rounded-full hover:bg-gray-800 transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"></path></svg>
                </button>
            </div>
        </div>
      </div>
    `;
    document.body.appendChild(div);

    // Refine Button Logic
    document.getElementById('ai-send-btn').addEventListener('click', () => {
        const input = document.getElementById('ai-refine-input');
        const val = input.value.trim();
        if(val) {
            handleAiSearch(val); // Re-runs search with history
            input.value = '';
        }
    });
}

// Chat UI Helpers
function addChatMessage(role, text) {
    const container = document.getElementById('ai-chat-container');
    const div = document.createElement('div');
    div.className = role === 'user' ? 'flex justify-end' : 'flex justify-start';
    div.innerHTML = `
        <div class="${role === 'user' ? 'bg-black text-white' : 'bg-white border text-gray-800'} px-5 py-2.5 rounded-2xl max-w-[85%] text-sm shadow-sm">
            ${text}
        </div>
    `;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
}

function addAiResponse(preText, products) {
    const container = document.getElementById('ai-chat-container');
    
    const msgDiv = document.createElement('div');
    msgDiv.className = 'flex flex-col items-start gap-3 max-w-full w-full';
    msgDiv.innerHTML = `
        <div class="bg-white border px-5 py-3 rounded-2xl rounded-tl-none text-gray-800 text-sm shadow-sm">
            ${preText}
        </div>
    `;
    
    if (products.length > 0) {
        const carousel = document.createElement('div');
        carousel.className = 'flex overflow-x-auto space-x-4 w-full py-2 pb-4 snap-x hide-scrollbar px-1';
        products.forEach(p => {
            carousel.appendChild(createProductCard(p, true)); // True = Horizontal Style
        });
        msgDiv.appendChild(carousel);
    }

    container.appendChild(msgDiv);
    container.scrollTop = container.scrollHeight;
}

function addLoadingIndicator() {
    const id = 'loading-' + Date.now();
    const container = document.getElementById('ai-chat-container');
    const div = document.createElement('div');
    div.id = id;
    div.className = 'flex justify-start';
    div.innerHTML = `
        <div class="bg-gray-100 px-4 py-2 rounded-2xl rounded-tl-none text-xs text-gray-500 flex items-center gap-2">
            <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></span>
            <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></span>
            <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
        </div>
    `;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
    return id;
}

function removeLoadingIndicator(id) {
    const el = document.getElementById(id);
    if(el) el.remove();
}

// Init
init();
</script>

<!-- Floating WhatsApp Button -->
<a id="whatsappBtn" href="javascript:void(0);" onclick="openWhatsApp()" class="fixed bottom-6 right-6 z-50 w-16 h-16 bg-[#25D366] hover:bg-[#1fbb57] text-white rounded-full shadow-lg flex items-center justify-center transition-all transform hover:scale-110 hover:shadow-xl" title="Chat with us on WhatsApp" aria-label="Open WhatsApp">
    <img src="images/whatsapp.svg" alt="WhatsApp" class="w-8 h-8" />
</a>

<script>
function openWhatsApp() {
    const phoneNumber = "254704843554";
    const message = "Hello! I'm interested in your products.";
    const encodedMsg = encodeURIComponent(message);
    
    const appLink = `whatsapp://send?phone=${phoneNumber}&text=${encodedMsg}`;
    const webLink = `https://wa.me/${phoneNumber}?text=${encodedMsg}`;
    
    if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
        window.location.href = appLink;
        setTimeout(() => { window.location.href = webLink; }, 2000);
    } else {
        window.open(webLink, '_blank');
    }
}
</script>
</body>
</html>
